
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>aviary.interface.methods_for_level2</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/aviary/interface/methods_for_level2';</script>
    <link rel="icon" href="../../../_static/aviary_logo.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/aviary.png" class="logo__image only-light" alt=" - Home"/>
    <script>document.write(`<img src="../../../_static/aviary.png" class="logo__image only-dark" alt=" - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../intro.html">
                    Aviary Documentation
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/what_aviary_does.html">What Aviary Does</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/tools_that_aviary_uses.html">Tools That Aviary is Built Upon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/expected_user_knowledge.html">Expected User Knowledge</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../getting_started/onboarding.html">Onboarding Guide</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/onboarding_level1.html">Level 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/onboarding_level2.html">Level 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/onboarding_level3.html">Level 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/onboarding_ext_subsystem.html">Models with External Subsystems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_started/input_csv_phase_info.html">Vehicle Input .csv File and Phase_info Dictionary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/now_what.html">Now What?</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../user_guide/user_interface.html">Aviary User Interface</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/UI_Levels.html">User Interface Levels</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/examples_of_the_same_mission_at_different_UI_levels.html">Examples of the same mission at different UI levels</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/aviary_commands.html">Command Line Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/input_files.html">Input Files</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/drawing_and_running_simple_missions.html">Drawing and running simple missions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/pre_mission_and_mission.html">Pre-Mission and Mission</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/outputs_and_how_to_read_them.html">Outputs and How to Read Them</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/variable_metadata.html">Understanding the Variable Metadata</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../user_guide/features_and_functionalities.html">Features and Functionalities</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/aerodynamics.html">Aerodynamics Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/external_aero.html">Externally Computed Polars</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/propulsion.html">Propulsion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/hamilton_standard.html">Hamilton Standard Propulsion Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/mass.html">Mass Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/subsystems.html">SubsystemBuilderBase</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/using_external_subsystems.html">Using external subsystems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/step_by_step_external_guide.html">Step-by-step guide for creating, testing, and using external subsystems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/battery_subsystem_example.html">In-depth look at the battery subsystem as an example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/features/overriding.html">Overriding Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/FLOPS_based_detailed_takeoff_and_landing.html">FLOPS Based Detailed Takeoff and Landing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../user_guide/reserve_missions.html">Reserve Mission</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/troubleshooting.html">Troubleshooting</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../examples/intro.html">Discussing the Aviary Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/simple_mission_example.html">Conventional Aircraft and Simple Mission</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/more_advanced_example.html">Optimizing the Mission Profile of a Conventional Aircraft</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/coupled_aircraft_mission_optimization.html">Coupled Aircraft-Mission Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/additional_flight_phases.html">Mission Optimization with Many Phases for a Commercial Aircraft</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/reserve_missions.html">Reserve Mission Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/OAS_subsystem.html">Using Aviary and OpenAeroStruct Together</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/level_2_detailed_takeoff_and_landing.html">Level 2 Detailed Takeoff and Landing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Theory Guide</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../theory_guide/intro.html">Overview of Aviary Functionality</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../theory_guide/underlying_concepts.html">Underlying Concepts</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../theory_guide/assumptions.html">Assumptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../theory_guide/aerodynamics.html">Core Aerodynamics Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../theory_guide/geometry.html">Core Geometry Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../theory_guide/mass.html">Core Mass Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../theory_guide/mission.html">Mission Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../theory_guide/propulsion.html">Core Propulsion Subsystem</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../theory_guide/optimization_algorithms.html">Optimization Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../theory_guide/validation.html">Validation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Developer Guide</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/codebase_overview.html">Codebase Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/coding_standards.html">Coding Standards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/unit_tests.html">Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/contributing_guidelines.html">Guidelines for Contributing Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/how_to_contribute_docs.html">How to Contribute Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer_guide/debugging_env_from_github.html">Using Dev Environments from GitHub Actions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Miscellaneous Resources</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../misc_resources/FAQ.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc_resources/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc_resources/resources.html">Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc_resources/externally_supported_subsystems.html">Externally Supported Subsystems</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../misc_resources/feature_comparison.html">Feature Comparison with Legacy Codes</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../misc_resources/comparison_to_flops.html">Comparison to FLOPS</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc_resources/planned_future_features.html">Planned Future Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_srcdocs/index.html">Source Docs</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/openmdao/Aviary" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/openmdao/Aviary/issues/new?title=Issue%20on%20page%20%2F_modules/aviary/interface/methods_for_level2.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for aviary.interface.methods_for_level2</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">importlib.util</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">dymos</span> <span class="k">as</span> <span class="nn">dm</span>
<span class="kn">from</span> <span class="nn">dymos.utils.misc</span> <span class="kn">import</span> <span class="n">_unspecified</span>

<span class="kn">import</span> <span class="nn">openmdao.api</span> <span class="k">as</span> <span class="nn">om</span>
<span class="kn">from</span> <span class="nn">openmdao.core.component</span> <span class="kn">import</span> <span class="n">Component</span>
<span class="kn">from</span> <span class="nn">openmdao.utils.mpi</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span> <span class="nn">openmdao.utils.reports_system</span> <span class="kn">import</span> <span class="n">_default_reports</span>

<span class="kn">from</span> <span class="nn">aviary.constants</span> <span class="kn">import</span> <span class="n">GRAV_ENGLISH_LBM</span><span class="p">,</span> <span class="n">RHO_SEA_LEVEL_ENGLISH</span>
<span class="kn">from</span> <span class="nn">aviary.mission.flops_based.phases.build_landing</span> <span class="kn">import</span> <span class="n">Landing</span>
<span class="kn">from</span> <span class="nn">aviary.mission.flops_based.phases.build_takeoff</span> <span class="kn">import</span> <span class="n">Takeoff</span>
<span class="kn">from</span> <span class="nn">aviary.mission.energy_phase</span> <span class="kn">import</span> <span class="n">EnergyPhase</span>
<span class="kn">from</span> <span class="nn">aviary.mission.twodof_phase</span> <span class="kn">import</span> <span class="n">TwoDOFPhase</span>
<span class="kn">from</span> <span class="nn">aviary.mission.gasp_based.ode.params</span> <span class="kn">import</span> <span class="n">ParamPort</span>
<span class="kn">from</span> <span class="nn">aviary.mission.gasp_based.phases.time_integration_traj</span> <span class="kn">import</span> <span class="n">FlexibleTraj</span>
<span class="kn">from</span> <span class="nn">aviary.mission.gasp_based.phases.time_integration_phases</span> <span class="kn">import</span> <span class="n">SGMCruise</span>
<span class="kn">from</span> <span class="nn">aviary.mission.gasp_based.phases.groundroll_phase</span> <span class="kn">import</span> <span class="n">GroundrollPhase</span>
<span class="kn">from</span> <span class="nn">aviary.mission.flops_based.phases.groundroll_phase</span> <span class="kn">import</span> <span class="n">GroundrollPhase</span> <span class="k">as</span> <span class="n">GroundrollPhaseVelocityIntegrated</span>
<span class="kn">from</span> <span class="nn">aviary.mission.gasp_based.phases.rotation_phase</span> <span class="kn">import</span> <span class="n">RotationPhase</span>
<span class="kn">from</span> <span class="nn">aviary.mission.gasp_based.phases.climb_phase</span> <span class="kn">import</span> <span class="n">ClimbPhase</span>
<span class="kn">from</span> <span class="nn">aviary.mission.gasp_based.phases.cruise_phase</span> <span class="kn">import</span> <span class="n">CruisePhase</span>
<span class="kn">from</span> <span class="nn">aviary.mission.gasp_based.phases.accel_phase</span> <span class="kn">import</span> <span class="n">AccelPhase</span>
<span class="kn">from</span> <span class="nn">aviary.mission.gasp_based.phases.ascent_phase</span> <span class="kn">import</span> <span class="n">AscentPhase</span>
<span class="kn">from</span> <span class="nn">aviary.mission.gasp_based.phases.descent_phase</span> <span class="kn">import</span> <span class="n">DescentPhase</span>
<span class="kn">from</span> <span class="nn">aviary.mission.gasp_based.phases.landing_group</span> <span class="kn">import</span> <span class="n">LandingSegment</span>
<span class="kn">from</span> <span class="nn">aviary.mission.gasp_based.phases.taxi_group</span> <span class="kn">import</span> <span class="n">TaxiSegment</span>
<span class="kn">from</span> <span class="nn">aviary.mission.gasp_based.phases.v_rotate_comp</span> <span class="kn">import</span> <span class="n">VRotateComp</span>
<span class="kn">from</span> <span class="nn">aviary.mission.gasp_based.polynomial_fit</span> <span class="kn">import</span> <span class="n">PolynomialFit</span>
<span class="kn">from</span> <span class="nn">aviary.subsystems.premission</span> <span class="kn">import</span> <span class="n">CorePreMission</span>
<span class="kn">from</span> <span class="nn">aviary.utils.functions</span> <span class="kn">import</span> <span class="n">create_opts2vals</span><span class="p">,</span> <span class="n">add_opts2vals</span><span class="p">,</span> <span class="n">promote_aircraft_and_mission_vars</span><span class="p">,</span> <span class="n">wrapped_convert_units</span>
<span class="kn">from</span> <span class="nn">aviary.utils.process_input_decks</span> <span class="kn">import</span> <span class="n">create_vehicle</span><span class="p">,</span> <span class="n">update_GASP_options</span><span class="p">,</span> <span class="n">initial_guessing</span>
<span class="kn">from</span> <span class="nn">aviary.utils.preprocessors</span> <span class="kn">import</span> <span class="n">preprocess_crewpayload</span>
<span class="kn">from</span> <span class="nn">aviary.interface.utils.check_phase_info</span> <span class="kn">import</span> <span class="n">check_phase_info</span>
<span class="kn">from</span> <span class="nn">aviary.utils.aviary_values</span> <span class="kn">import</span> <span class="n">AviaryValues</span>

<span class="kn">from</span> <span class="nn">aviary.variable_info.functions</span> <span class="kn">import</span> <span class="n">setup_trajectory_params</span><span class="p">,</span> <span class="n">override_aviary_vars</span>
<span class="kn">from</span> <span class="nn">aviary.variable_info.variables</span> <span class="kn">import</span> <span class="n">Aircraft</span><span class="p">,</span> <span class="n">Mission</span><span class="p">,</span> <span class="n">Dynamic</span><span class="p">,</span> <span class="n">Settings</span>
<span class="kn">from</span> <span class="nn">aviary.variable_info.enums</span> <span class="kn">import</span> <span class="n">AnalysisScheme</span><span class="p">,</span> <span class="n">ProblemType</span><span class="p">,</span> <span class="n">SpeedType</span><span class="p">,</span> <span class="n">AlphaModes</span><span class="p">,</span> <span class="n">EquationsOfMotion</span><span class="p">,</span> <span class="n">LegacyCode</span><span class="p">,</span> <span class="n">Verbosity</span>
<span class="kn">from</span> <span class="nn">aviary.variable_info.variable_meta_data</span> <span class="kn">import</span> <span class="n">_MetaData</span> <span class="k">as</span> <span class="n">BaseMetaData</span>

<span class="kn">from</span> <span class="nn">aviary.subsystems.propulsion.engine_deck</span> <span class="kn">import</span> <span class="n">EngineDeck</span>
<span class="kn">from</span> <span class="nn">aviary.subsystems.propulsion.propulsion_builder</span> <span class="kn">import</span> <span class="n">CorePropulsionBuilder</span>
<span class="kn">from</span> <span class="nn">aviary.subsystems.geometry.geometry_builder</span> <span class="kn">import</span> <span class="n">CoreGeometryBuilder</span>
<span class="kn">from</span> <span class="nn">aviary.subsystems.mass.mass_builder</span> <span class="kn">import</span> <span class="n">CoreMassBuilder</span>
<span class="kn">from</span> <span class="nn">aviary.subsystems.aerodynamics.aerodynamics_builder</span> <span class="kn">import</span> <span class="n">CoreAerodynamicsBuilder</span>
<span class="kn">from</span> <span class="nn">aviary.utils.preprocessors</span> <span class="kn">import</span> <span class="n">preprocess_propulsion</span>
<span class="kn">from</span> <span class="nn">aviary.utils.merge_variable_metadata</span> <span class="kn">import</span> <span class="n">merge_meta_data</span>

<span class="kn">from</span> <span class="nn">aviary.interface.default_phase_info.two_dof_fiti</span> <span class="kn">import</span> <span class="n">create_2dof_based_ascent_phases</span><span class="p">,</span> <span class="n">create_2dof_based_descent_phases</span>
<span class="kn">from</span> <span class="nn">aviary.mission.gasp_based.idle_descent_estimation</span> <span class="kn">import</span> <span class="n">descent_range_and_fuel</span>
<span class="kn">from</span> <span class="nn">aviary.mission.phase_builder_base</span> <span class="kn">import</span> <span class="n">PhaseBuilderBase</span>


<span class="n">FLOPS</span> <span class="o">=</span> <span class="n">LegacyCode</span><span class="o">.</span><span class="n">FLOPS</span>
<span class="n">GASP</span> <span class="o">=</span> <span class="n">LegacyCode</span><span class="o">.</span><span class="n">GASP</span>

<span class="n">TWO_DEGREES_OF_FREEDOM</span> <span class="o">=</span> <span class="n">EquationsOfMotion</span><span class="o">.</span><span class="n">TWO_DEGREES_OF_FREEDOM</span>
<span class="n">HEIGHT_ENERGY</span> <span class="o">=</span> <span class="n">EquationsOfMotion</span><span class="o">.</span><span class="n">HEIGHT_ENERGY</span>
<span class="n">SOLVED_2DOF</span> <span class="o">=</span> <span class="n">EquationsOfMotion</span><span class="o">.</span><span class="n">SOLVED_2DOF</span>


<div class="viewcode-block" id="PreMissionGroup">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.PreMissionGroup">[docs]</a>
<span class="k">class</span> <span class="nc">PreMissionGroup</span><span class="p">(</span><span class="n">om</span><span class="o">.</span><span class="n">Group</span><span class="p">):</span>
<div class="viewcode-block" id="PreMissionGroup.configure">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.PreMissionGroup.configure">[docs]</a>
    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">external_outputs</span> <span class="o">=</span> <span class="n">promote_aircraft_and_mission_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">statics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_subsystems</span>
        <span class="n">override_aviary_vars</span><span class="p">(</span><span class="n">statics</span><span class="p">,</span> <span class="n">statics</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;aviary_options&quot;</span><span class="p">],</span>
                             <span class="n">external_overrides</span><span class="o">=</span><span class="n">external_outputs</span><span class="p">,</span>
                             <span class="n">manual_overrides</span><span class="o">=</span><span class="n">statics</span><span class="o">.</span><span class="n">manual_overrides</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="PostMissionGroup">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.PostMissionGroup">[docs]</a>
<span class="k">class</span> <span class="nc">PostMissionGroup</span><span class="p">(</span><span class="n">om</span><span class="o">.</span><span class="n">Group</span><span class="p">):</span>
<div class="viewcode-block" id="PostMissionGroup.configure">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.PostMissionGroup.configure">[docs]</a>
    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">promote_aircraft_and_mission_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="AviaryGroup">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryGroup">[docs]</a>
<span class="k">class</span> <span class="nc">AviaryGroup</span><span class="p">(</span><span class="n">om</span><span class="o">.</span><span class="n">Group</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A standard OpenMDAO group that handles Aviary&#39;s promotions in the configure</span>
<span class="sd">    method. This assures that we only call set_input_defaults on variables</span>
<span class="sd">    that are present in the model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AviaryGroup.initialize">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryGroup.initialize">[docs]</a>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span>
            <span class="s1">&#39;aviary_options&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="n">AviaryValues</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;collection of Aircraft/Mission specific options&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span>
            <span class="s1">&#39;aviary_metadata&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;metadata dictionary of the full aviary problem.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span>
            <span class="s1">&#39;phase_info&#39;</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span>
            <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;phase-specific settings.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AviaryGroup.configure">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryGroup.configure">[docs]</a>
    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">aviary_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;aviary_options&#39;</span><span class="p">]</span>
        <span class="n">aviary_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;aviary_metadata&#39;</span><span class="p">]</span>

        <span class="c1"># Find promoted name of every input in the model.</span>
        <span class="n">all_prom_inputs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># We can call list_inputs on the groups.</span>
        <span class="k">for</span> <span class="n">system</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_iter</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="n">om</span><span class="o">.</span><span class="n">Group</span><span class="p">):</span>
            <span class="n">var_abs</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">list_inputs</span><span class="p">(</span><span class="n">out_stream</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">var_prom</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;prom_name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_abs</span><span class="p">]</span>
            <span class="n">all_prom_inputs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">var_prom</span><span class="p">)</span>

        <span class="c1"># Component promotes aren&#39;t handled until this group resolves.</span>
        <span class="c1"># Here, we address anything promoted with an alias in AviaryProblem.</span>
        <span class="k">for</span> <span class="n">system</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_iter</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="n">Component</span><span class="p">):</span>
            <span class="n">input_meta</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">_var_promotes</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span>
            <span class="n">var_prom</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">input_meta</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">)]</span>
            <span class="n">all_prom_inputs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">var_prom</span><span class="p">)</span>
            <span class="n">var_prom</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">input_meta</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">)]</span>
            <span class="n">all_prom_inputs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">var_prom</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">MPI</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Under MPI, promotion info only lives on rank 0, so broadcast.</span>
            <span class="n">all_prom_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">all_prom_inputs</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">aviary_metadata</span><span class="p">:</span>

            <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">or</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;dynamic:&#39;</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">aviary_metadata</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;option&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="c1"># Skip anything that is not presently an input.</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_prom_inputs</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">aviary_options</span><span class="p">:</span>
                <span class="n">val</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="n">aviary_options</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">aviary_metadata</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span>
                <span class="n">units</span> <span class="o">=</span> <span class="n">aviary_metadata</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># optional, but no default value</span>
                    <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">set_input_defaults</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>

        <span class="c1"># The section below this contains some manipulations of the dymos solver</span>
        <span class="c1"># structure for height energy.</span>
        <span class="k">if</span> <span class="n">aviary_options</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">EQUATIONS_OF_MOTION</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">HEIGHT_ENERGY</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">phase_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;phase_info&#39;</span><span class="p">]</span>

        <span class="c1"># Set a more appropriate solver for dymos when the phases are linked.</span>
        <span class="k">if</span> <span class="n">MPI</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">phases</span><span class="o">.</span><span class="n">linear_solver</span><span class="p">,</span> <span class="n">om</span><span class="o">.</span><span class="n">PETScKrylov</span><span class="p">):</span>

            <span class="c1"># When any phase is connected with input_initial = True, dymos puts</span>
            <span class="c1"># a jacobi solver in the phases group. This is necessary in case</span>
            <span class="c1"># the phases are cyclic. However, this causes some problems</span>
            <span class="c1"># with the newton solvers in Aviary, exacerbating issues with</span>
            <span class="c1"># solver tolerances at multiple levels. Since Aviary&#39;s phases</span>
            <span class="c1"># are basically in series, the jacobi solver is a much better</span>
            <span class="c1"># choice and should be able to handle it in a couple of</span>
            <span class="c1"># iterations.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">phases</span><span class="o">.</span><span class="n">linear_solver</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">LinearBlockJac</span><span class="p">(</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Due to recent changes in dymos, there is now a solver in any phase</span>
        <span class="c1"># that has connected initial states. It is not clear that this solver</span>
        <span class="c1"># is necessary except in certain corner cases that do not apply to the</span>
        <span class="c1"># Aviary trajectory. In our case, this solver merely addresses a lag</span>
        <span class="c1"># in the state input component. Since this solver can cause some</span>
        <span class="c1"># numerical problems, and can slow things down, we need to move it down</span>
        <span class="c1"># into the state interp component.</span>
        <span class="c1"># TODO: Future updates to dymos may make this unneccesary.</span>
        <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">phases</span><span class="o">.</span><span class="n">system_iter</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

            <span class="c1"># Don&#39;t move the solvers if we are using solve segements.</span>
            <span class="k">if</span> <span class="n">phase_info</span><span class="p">[</span><span class="n">phase</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;solve_for_distance&#39;</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">phase</span><span class="o">.</span><span class="n">nonlinear_solver</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">NonlinearRunOnce</span><span class="p">()</span>
            <span class="n">phase</span><span class="o">.</span><span class="n">linear_solver</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">LinearRunOnce</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">indep_states</span><span class="p">,</span> <span class="n">om</span><span class="o">.</span><span class="n">ImplicitComponent</span><span class="p">):</span>
                <span class="n">phase</span><span class="o">.</span><span class="n">indep_states</span><span class="o">.</span><span class="n">nonlinear_solver</span> <span class="o">=</span> \
                    <span class="n">om</span><span class="o">.</span><span class="n">NewtonSolver</span><span class="p">(</span><span class="n">solve_subsystems</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">phase</span><span class="o">.</span><span class="n">indep_states</span><span class="o">.</span><span class="n">linear_solver</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">DirectSolver</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="AviaryProblem">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem">[docs]</a>
<span class="k">class</span> <span class="nc">AviaryProblem</span><span class="p">(</span><span class="n">om</span><span class="o">.</span><span class="n">Problem</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main class for instantiating, formulating, and solving Aviary problems.</span>

<span class="sd">    On a basic level, this problem object is all the conventional user needs</span>
<span class="sd">    to interact with. Looking at the three &quot;levels&quot; of use cases, from simplest</span>
<span class="sd">    to most complicated, we have:</span>

<span class="sd">    Level 1: users interact with Aviary through input files (.csv or .yaml, TBD)</span>
<span class="sd">    Level 2: users interact with Aviary through a Python interface</span>
<span class="sd">    Level 3: users can modify Aviary&#39;s workings through Python and OpenMDAO</span>

<span class="sd">    This Problem object is simply a specialized OpenMDAO Problem that has</span>
<span class="sd">    additional methods to help users create and solve Aviary problems.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AviaryProblem.__init__">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_scheme</span><span class="o">=</span><span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">COLLOCATION</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Modify OpenMDAO&#39;s default_reports for this session.</span>
        <span class="n">new_reports</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;subsystems&#39;</span><span class="p">,</span> <span class="s1">&#39;mission&#39;</span><span class="p">,</span> <span class="s1">&#39;timeseries_csv&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">report</span> <span class="ow">in</span> <span class="n">new_reports</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">report</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_default_reports</span><span class="p">:</span>
                <span class="n">_default_reports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">AviaryGroup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission</span> <span class="o">=</span> <span class="n">PreMissionGroup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span> <span class="o">=</span> <span class="n">PostMissionGroup</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">traj</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="o">=</span> <span class="n">analysis_scheme</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">regular_phases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reserve_phases</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="AviaryProblem.load_inputs">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.load_inputs">[docs]</a>
    <span class="k">def</span> <span class="nf">load_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aviary_inputs</span><span class="p">,</span> <span class="n">phase_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">engine_builder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">Verbosity</span><span class="o">.</span><span class="n">BRIEF</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method loads the aviary_values inputs and options that the</span>
<span class="sd">        user specifies. They could specify files to load and values to</span>
<span class="sd">        replace here as well.</span>
<span class="sd">        Phase info is also loaded if provided by the user. If phase_info is None,</span>
<span class="sd">        the appropriate default phase_info based on mission analysis method is used.</span>

<span class="sd">        This method is not strictly necessary; a user could also supply</span>
<span class="sd">        an AviaryValues object and/or phase_info dict of their own.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">## LOAD INPUT FILE ###</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine_builder</span> <span class="o">=</span> <span class="n">engine_builder</span>

        <span class="c1"># Create AviaryValues object from file (or process existing AviaryValues object</span>
        <span class="c1"># with default values from metadata) and generate initial guesses</span>
        <span class="n">aviary_inputs</span><span class="p">,</span> <span class="n">initial_guesses</span> <span class="o">=</span> <span class="n">create_vehicle</span><span class="p">(</span>
            <span class="n">aviary_inputs</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>

        <span class="c1"># pull which methods will be used for subsystems and mission</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="o">=</span> <span class="n">mission_method</span> <span class="o">=</span> <span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span>
            <span class="n">Settings</span><span class="o">.</span><span class="n">EQUATIONS_OF_MOTION</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mass_method</span> <span class="o">=</span> <span class="n">mass_method</span> <span class="o">=</span> <span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Settings</span><span class="o">.</span><span class="n">MASS_METHOD</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mission_method</span> <span class="ow">is</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span> <span class="ow">or</span> <span class="n">mass_method</span> <span class="ow">is</span> <span class="n">GASP</span><span class="p">:</span>
            <span class="n">aviary_inputs</span> <span class="o">=</span> <span class="n">update_GASP_options</span><span class="p">(</span><span class="n">aviary_inputs</span><span class="p">)</span>
            <span class="n">initial_guesses</span> <span class="o">=</span> <span class="n">initial_guessing</span><span class="p">(</span><span class="n">aviary_inputs</span><span class="p">,</span> <span class="n">initial_guesses</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span> <span class="o">=</span> <span class="n">aviary_inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_guesses</span> <span class="o">=</span> <span class="n">initial_guesses</span>

        <span class="k">if</span> <span class="n">mission_method</span> <span class="ow">is</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">:</span>
            <span class="n">aviary_inputs</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">CRUISE_MASS_FINAL</span><span class="p">,</span>
                                  <span class="n">val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_guesses</span><span class="p">[</span><span class="s1">&#39;cruise_mass_final&#39;</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;lbm&#39;</span><span class="p">)</span>
            <span class="n">aviary_inputs</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">,</span>
                                  <span class="n">val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_guesses</span><span class="p">[</span><span class="s1">&#39;actual_takeoff_mass&#39;</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;lbm&#39;</span><span class="p">)</span>

            <span class="c1"># Commonly referenced values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cruise_alt</span> <span class="o">=</span> <span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span>
                <span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">CRUISE_ALTITUDE</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;ft&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">problem_type</span> <span class="o">=</span> <span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="s1">&#39;problem_type&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass_defect</span> <span class="o">=</span> <span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="s1">&#39;mass_defect&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;lbm&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cruise_mass_final</span> <span class="o">=</span> <span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span>
                <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">CRUISE_MASS_FINAL</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;lbm&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target_range</span> <span class="o">=</span> <span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span>
                <span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">RANGE</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;NM&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cruise_mach</span> <span class="o">=</span> <span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">MACH</span><span class="p">)</span>

        <span class="c1">## LOAD PHASE_INFO ###</span>
        <span class="k">if</span> <span class="n">phase_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># check if the user generated a phase_info from gui</span>
            <span class="c1"># Load the phase info dynamically from the current working directory</span>
            <span class="n">phase_info_module_path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span> <span class="o">/</span> <span class="s1">&#39;outputted_phase_info.py&#39;</span>

            <span class="k">if</span> <span class="n">phase_info_module_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">spec_from_file_location</span><span class="p">(</span>
                    <span class="s1">&#39;outputted_phase_info&#39;</span><span class="p">,</span> <span class="n">phase_info_module_path</span><span class="p">)</span>
                <span class="n">outputted_phase_info</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">module_from_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;outputted_phase_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outputted_phase_info</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">exec_module</span><span class="p">(</span><span class="n">outputted_phase_info</span><span class="p">)</span>

                <span class="c1"># Access the phase_info variable from the loaded module</span>
                <span class="n">phase_info</span> <span class="o">=</span> <span class="n">outputted_phase_info</span><span class="o">.</span><span class="n">phase_info</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">aviary.interface.default_phase_info.two_dof</span> <span class="kn">import</span> <span class="n">phase_info</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">HEIGHT_ENERGY</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">aviary.interface.default_phase_info.height_energy</span> <span class="kn">import</span> <span class="n">phase_info</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loaded default phase_info for &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1"> equations of motion&#39;</span><span class="p">)</span>

        <span class="c1"># create a new dictionary that only contains the phases from phase_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="n">phase_info</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;external_subsystems&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]:</span>
                <span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;external_subsystems&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">phase_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pre_mission&#39;</span><span class="p">,</span> <span class="s1">&#39;post_mission&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span>

        <span class="c1"># pre_mission and post_mission are stored in their own dictionaries.</span>
        <span class="k">if</span> <span class="s1">&#39;pre_mission&#39;</span> <span class="ow">in</span> <span class="n">phase_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission_info</span> <span class="o">=</span> <span class="n">phase_info</span><span class="p">[</span><span class="s1">&#39;pre_mission&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;include_takeoff&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                     <span class="s1">&#39;external_subsystems&#39;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="k">if</span> <span class="s1">&#39;post_mission&#39;</span> <span class="ow">in</span> <span class="n">phase_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_mission_info</span> <span class="o">=</span> <span class="n">phase_info</span><span class="p">[</span><span class="s1">&#39;post_mission&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_mission_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;include_landing&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                      <span class="s1">&#39;external_subsystems&#39;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="c1">## PROCESSING ##</span>
        <span class="c1"># set up core subsystems</span>
        <span class="k">if</span> <span class="n">mission_method</span> <span class="ow">in</span> <span class="p">(</span><span class="n">HEIGHT_ENERGY</span><span class="p">,</span> <span class="n">SOLVED_2DOF</span><span class="p">):</span>
            <span class="n">everything_else_origin</span> <span class="o">=</span> <span class="n">FLOPS</span>
        <span class="k">elif</span> <span class="n">mission_method</span> <span class="ow">is</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">:</span>
            <span class="n">everything_else_origin</span> <span class="o">=</span> <span class="n">GASP</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown mission method </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">prop</span> <span class="o">=</span> <span class="n">CorePropulsionBuilder</span><span class="p">(</span><span class="s1">&#39;core_propulsion&#39;</span><span class="p">)</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="n">CoreMassBuilder</span><span class="p">(</span><span class="s1">&#39;core_mass&#39;</span><span class="p">,</span> <span class="n">code_origin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_method</span><span class="p">)</span>
        <span class="n">aero</span> <span class="o">=</span> <span class="n">CoreAerodynamicsBuilder</span><span class="p">(</span>
            <span class="s1">&#39;core_aerodynamics&#39;</span><span class="p">,</span> <span class="n">code_origin</span><span class="o">=</span><span class="n">everything_else_origin</span><span class="p">)</span>

        <span class="c1"># TODO These values are currently hardcoded, in future should come from user</span>
        <span class="n">both_geom</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">code_origin_to_prioritize</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># which geometry methods should be used, or both?</span>
        <span class="n">geom_code_origin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">everything_else_origin</span> <span class="ow">is</span> <span class="n">FLOPS</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mass_method</span> <span class="ow">is</span> <span class="n">FLOPS</span><span class="p">):</span>
            <span class="n">geom_code_origin</span> <span class="o">=</span> <span class="n">FLOPS</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">everything_else_origin</span> <span class="ow">is</span> <span class="n">GASP</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mass_method</span> <span class="ow">is</span> <span class="n">GASP</span><span class="p">):</span>
            <span class="n">geom_code_origin</span> <span class="o">=</span> <span class="n">GASP</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">both_geom</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># which geometry method gets prioritized in case of conflicting outputs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">code_origin_to_prioritize</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">everything_else_origin</span> <span class="ow">is</span> <span class="n">GASP</span><span class="p">:</span>
                <span class="n">code_origin_to_prioritize</span> <span class="o">=</span> <span class="n">GASP</span>
            <span class="k">elif</span> <span class="n">everything_else_origin</span> <span class="ow">is</span> <span class="n">FLOPS</span><span class="p">:</span>
                <span class="n">code_origin_to_prioritize</span> <span class="o">=</span> <span class="n">FLOPS</span>

        <span class="n">geom</span> <span class="o">=</span> <span class="n">CoreGeometryBuilder</span><span class="p">(</span><span class="s1">&#39;core_geometry&#39;</span><span class="p">,</span>
                                   <span class="n">code_origin</span><span class="o">=</span><span class="n">geom_code_origin</span><span class="p">,</span>
                                   <span class="n">use_both_geometries</span><span class="o">=</span><span class="n">both_geom</span><span class="p">,</span>
                                   <span class="n">code_origin_to_prioritize</span><span class="o">=</span><span class="n">code_origin_to_prioritize</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">core_subsystems</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;propulsion&#39;</span><span class="p">:</span> <span class="n">prop</span><span class="p">,</span>
                                <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">geom</span><span class="p">,</span>
                                <span class="s1">&#39;mass&#39;</span><span class="p">:</span> <span class="n">mass</span><span class="p">,</span>
                                <span class="s1">&#39;aerodynamics&#39;</span><span class="p">:</span> <span class="n">aero</span><span class="p">}</span>

        <span class="c1"># TODO optionally accept which subsystems to load from phase_info</span>
        <span class="n">subsystems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_subsystems</span>
        <span class="n">default_mission_subsystems</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">subsystems</span><span class="p">[</span><span class="s1">&#39;aerodynamics&#39;</span><span class="p">],</span> <span class="n">subsystems</span><span class="p">[</span><span class="s1">&#39;propulsion&#39;</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ode_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">aviary_options</span><span class="o">=</span><span class="n">aviary_inputs</span><span class="p">,</span>
                             <span class="n">core_subsystems</span><span class="o">=</span><span class="n">default_mission_subsystems</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">engine_builder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">engine</span> <span class="o">=</span> <span class="n">EngineDeck</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">aviary_inputs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">engine</span> <span class="o">=</span> <span class="n">engine_builder</span>

        <span class="n">preprocess_propulsion</span><span class="p">(</span><span class="n">aviary_inputs</span><span class="p">,</span> <span class="p">[</span><span class="n">engine</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_metadata_from_subsystems</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span> <span class="o">=</span> <span class="n">aviary_inputs</span>
        <span class="k">return</span> <span class="n">aviary_inputs</span></div>


    <span class="k">def</span> <span class="nf">_update_metadata_from_subsystems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span> <span class="o">=</span> <span class="n">BaseMetaData</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">variables_to_pop</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># loop through phase_info and external subsystems</span>
        <span class="k">for</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">:</span>
            <span class="n">external_subsystems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_subsystems</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;external_subsystems&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">subsystem</span> <span class="ow">in</span> <span class="n">external_subsystems</span><span class="p">:</span>
                <span class="n">meta_data</span> <span class="o">=</span> <span class="n">subsystem</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="n">state_info</span> <span class="o">=</span> <span class="n">subsystem</span><span class="o">.</span><span class="n">get_states</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">state_info</span><span class="p">:</span>
                    <span class="n">variables_to_pop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
                    <span class="n">variables_to_pop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_info</span><span class="p">[</span><span class="n">state</span><span class="p">][</span><span class="s1">&#39;rate_source&#39;</span><span class="p">])</span>

                <span class="n">arg_spec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">subsystem</span><span class="o">.</span><span class="n">get_controls</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;phase_name&#39;</span> <span class="ow">in</span> <span class="n">arg_spec</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                    <span class="n">control_dicts</span> <span class="o">=</span> <span class="n">subsystem</span><span class="o">.</span><span class="n">get_controls</span><span class="p">(</span>
                        <span class="n">phase_name</span><span class="o">=</span><span class="n">phase_name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">control_dicts</span> <span class="o">=</span> <span class="n">subsystem</span><span class="o">.</span><span class="n">get_controls</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">control_name</span><span class="p">,</span> <span class="n">control_dict</span> <span class="ow">in</span> <span class="n">control_dicts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">variables_to_pop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">control_name</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">subsystem</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">():</span>
                    <span class="n">variables_to_pop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">subsystem</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">():</span>
                    <span class="n">variables_to_pop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span> <span class="o">=</span> <span class="n">merge_meta_data</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">,</span> <span class="n">meta_data</span><span class="p">])</span>

        <span class="n">variables_to_pop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">variables_to_pop</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">variables_to_pop</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>

<div class="viewcode-block" id="AviaryProblem.phase_separator">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.phase_separator">[docs]</a>
    <span class="k">def</span> <span class="nf">phase_separator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method checks for reserve=True &amp; False</span>
<span class="sd">        Returns an error if a non-reserve phase is specified after a reserve phase.</span>
<span class="sd">        return two dictionaries of phases: regular_phases and reserve_phases</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check to ensure no non-reserve phases are specified after reserve phases</span>
        <span class="n">start_reserve</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">raise_error</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;user_options&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s1">&#39;reserve&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s2">&quot;user_options&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s2">&quot;user_options&quot;</span><span class="p">][</span><span class="s2">&quot;reserve&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="c1"># This is a regular phase</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">regular_phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">start_reserve</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">raise_error</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># This is a reserve phase</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reserve_phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_name</span><span class="p">)</span>
                        <span class="n">start_reserve</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># This is a regular phase by default</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">regular_phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">start_reserve</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">raise_error</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">raise_error</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;In phase_info, reserve=False cannot be specified after a phase where reserve=True. &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;All reserve phases must happen after non-reserve phases. &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;Regular Phases : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">regular_phases</span><span class="si">}</span><span class="s1"> | &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;Reserve Phases : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reserve_phases</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AviaryProblem.check_and_preprocess_inputs">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.check_and_preprocess_inputs">[docs]</a>
    <span class="k">def</span> <span class="nf">check_and_preprocess_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method checks the user-supplied input values for any potential problems</span>
<span class="sd">        and preprocesses the inputs to prepare them for use in the Aviary problem.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Target_distance verification for all phases</span>
        <span class="c1"># Checks to make sure target_distance is positive,</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;user_options&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s1">&#39;target_distance&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s2">&quot;user_options&quot;</span><span class="p">]:</span>
                    <span class="n">target_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s2">&quot;user_options&quot;</span><span class="p">][</span><span class="s2">&quot;target_distance&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">target_distance</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Invalid target_distance in [</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">].[user_options]. &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Current (value: </span><span class="si">{</span><span class="n">target_distance</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">), (units: </span><span class="si">{</span><span class="n">target_distance</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">) &lt;= 0&quot;</span><span class="p">)</span>

        <span class="c1"># Checks to make sure target_duration is positive,</span>
        <span class="c1"># Sets duration_bounds, initial_guesses, and fixed_duration</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;user_options&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]:</span>
                <span class="n">analytic</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">COLLOCATION</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">EquationsOfMotion</span><span class="o">.</span><span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># if the user provided an option, use it</span>
                        <span class="n">analytic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s2">&quot;user_options&quot;</span><span class="p">][</span><span class="s1">&#39;analytic&#39;</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="c1"># if it isn&#39;t specified, only the default 2DOF cruise for collocation is analytic</span>
                        <span class="k">if</span> <span class="s1">&#39;cruise&#39;</span> <span class="ow">in</span> <span class="n">phase_name</span><span class="p">:</span>
                            <span class="n">analytic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s2">&quot;user_options&quot;</span><span class="p">][</span><span class="s1">&#39;analytic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">analytic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s2">&quot;user_options&quot;</span><span class="p">][</span><span class="s1">&#39;analytic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="s1">&#39;target_duration&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s2">&quot;user_options&quot;</span><span class="p">]:</span>
                    <span class="n">target_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s2">&quot;user_options&quot;</span><span class="p">][</span><span class="s2">&quot;target_duration&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">target_duration</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Invalid target_duration in phase_info[</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">][user_options]. &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Current (value: </span><span class="si">{</span><span class="n">target_duration</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">), (units: </span><span class="si">{</span><span class="n">target_duration</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">) &lt;= 0&quot;</span><span class="p">)</span>

                    <span class="c1"># Only applies to non-analytic phases (all HE and most 2DOF)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">analytic</span><span class="p">:</span>
                        <span class="c1"># Set duration_bounds and initial_guesses for time:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s2">&quot;user_options&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                            <span class="s2">&quot;duration_bounds&quot;</span><span class="p">:</span> <span class="p">((</span><span class="n">target_duration</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">target_duration</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">target_duration</span><span class="p">[</span><span class="mi">1</span><span class="p">])})</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                            <span class="s2">&quot;initial_guesses&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="p">((</span><span class="n">target_duration</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">target_duration</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">target_duration</span><span class="p">[</span><span class="mi">1</span><span class="p">])}})</span>
                        <span class="c1"># Set Fixed_duration to true:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s2">&quot;user_options&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                            <span class="s2">&quot;fix_duration&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

        <span class="n">check_phase_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">external_subsystem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;external_subsystems&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span> <span class="o">=</span> <span class="n">external_subsystem</span><span class="o">.</span><span class="n">preprocess_inputs</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="p">)</span>

        <span class="c1"># TODO find preprocessors a permanent home</span>
        <span class="c1"># PREPROCESSORS #</span>
        <span class="c1"># Fill in anything missing in the options with computed defaults.</span>
        <span class="n">preprocess_crewpayload</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">in</span> <span class="p">(</span><span class="n">HEIGHT_ENERGY</span><span class="p">,</span> <span class="n">SOLVED_2DOF</span><span class="p">,</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase_separator</span><span class="p">()</span></div>


<div class="viewcode-block" id="AviaryProblem.add_pre_mission_systems">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.add_pre_mission_systems">[docs]</a>
    <span class="k">def</span> <span class="nf">add_pre_mission_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add pre-mission systems to the Aviary problem. These systems are executed before the mission</span>
<span class="sd">        and are also known as the &quot;pre_mission&quot; group.</span>

<span class="sd">        Depending on the mission model specified (`FLOPS` or `GASP`), this method adds various subsystems</span>
<span class="sd">        to the aircraft model. For the `FLOPS` mission model, a takeoff phase is added using the Takeoff class</span>
<span class="sd">        with the number of engines and airport altitude specified. For the `GASP` mission model, three subsystems</span>
<span class="sd">        are added: a TaxiSegment subsystem, an ExecComp to calculate the time to initiate gear and flaps,</span>
<span class="sd">        and an ExecComp to calculate the speed at which to initiate rotation. All subsystems are promoted with</span>
<span class="sd">        aircraft and mission inputs and outputs as appropriate.</span>

<span class="sd">        A user can override this method with their own pre-mission systems as desired.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pre_mission</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;pre_mission&#39;</span><span class="p">,</span> <span class="n">pre_mission</span><span class="p">,</span>
                                 <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;aircraft:*&#39;</span><span class="p">,</span> <span class="s1">&#39;mission:*&#39;</span><span class="p">],</span>
                                 <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;aircraft:*&#39;</span><span class="p">,</span> <span class="s1">&#39;mission:*&#39;</span><span class="p">],)</span>

        <span class="k">if</span> <span class="s1">&#39;linear_solver&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission_info</span><span class="p">:</span>
            <span class="n">pre_mission</span><span class="o">.</span><span class="n">linear_solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission_info</span><span class="p">[</span><span class="s1">&#39;linear_solver&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;nonlinear_solver&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission_info</span><span class="p">:</span>
            <span class="n">pre_mission</span><span class="o">.</span><span class="n">nonlinear_solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission_info</span><span class="p">[</span><span class="s1">&#39;nonlinear_solver&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_premission_external_subsystems</span><span class="p">()</span>

        <span class="n">subsystems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_subsystems</span>
        <span class="n">default_subsystems</span> <span class="o">=</span> <span class="p">[</span><span class="n">subsystems</span><span class="p">[</span><span class="s1">&#39;propulsion&#39;</span><span class="p">],</span>
                              <span class="n">subsystems</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span>
                              <span class="n">subsystems</span><span class="p">[</span><span class="s1">&#39;aerodynamics&#39;</span><span class="p">],</span>
                              <span class="n">subsystems</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">],]</span>

        <span class="n">pre_mission</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="s1">&#39;core_subsystems&#39;</span><span class="p">,</span>
            <span class="n">CorePreMission</span><span class="p">(</span>
                <span class="n">aviary_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="p">,</span>
                <span class="n">subsystems</span><span class="o">=</span><span class="n">default_subsystems</span><span class="p">,</span>
                <span class="n">process_overrides</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">],</span>
            <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission_info</span><span class="p">[</span><span class="s1">&#39;include_takeoff&#39;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="c1"># Check for 2DOF mission method</span>
        <span class="c1"># NOTE should solved trigger this as well?</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_two_dof_takeoff_systems</span><span class="p">()</span>

        <span class="c1"># Check for HE mission method</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">HEIGHT_ENERGY</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_height_energy_takeoff_systems</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_add_height_energy_takeoff_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Initialize takeoff options</span>
        <span class="n">takeoff_options</span> <span class="o">=</span> <span class="n">Takeoff</span><span class="p">(</span>
            <span class="n">airport_altitude</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>  <span class="c1"># ft</span>
            <span class="n">num_engines</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Aircraft</span><span class="o">.</span><span class="n">Engine</span><span class="o">.</span><span class="n">NUM_ENGINES</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Build and add takeoff subsystem</span>
        <span class="n">takeoff</span> <span class="o">=</span> <span class="n">takeoff_options</span><span class="o">.</span><span class="n">build_phase</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="s1">&#39;takeoff&#39;</span><span class="p">,</span> <span class="n">takeoff</span><span class="p">,</span> <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;aircraft:*&#39;</span><span class="p">,</span> <span class="s1">&#39;mission:*&#39;</span><span class="p">],</span>
            <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mission:*&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_add_two_dof_takeoff_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Create options to values</span>
        <span class="n">OptionsToValues</span> <span class="o">=</span> <span class="n">create_opts2vals</span><span class="p">(</span>
            <span class="p">[</span><span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">NUM_PASSENGERS</span><span class="p">,</span>
                <span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">CRUISE_ALTITUDE</span><span class="p">,</span> <span class="p">])</span>
        <span class="n">add_opts2vals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">OptionsToValues</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">SHOOTING</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_fuel_reserve_component</span><span class="p">(</span><span class="n">post_mission</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Add thrust-to-weight ratio subsystem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="s1">&#39;tw_ratio&#39;</span><span class="p">,</span>
            <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;TW_ratio = Fn_SLS / (takeoff_mass * </span><span class="si">{</span><span class="n">GRAV_ENGLISH_LBM</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span>
                <span class="n">TW_ratio</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s2">&quot;unitless&quot;</span><span class="p">},</span>
                <span class="n">Fn_SLS</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbf&#39;</span><span class="p">},</span>
                <span class="n">takeoff_mass</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
            <span class="p">),</span>
            <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;Fn_SLS&#39;</span><span class="p">,</span> <span class="n">Aircraft</span><span class="o">.</span><span class="n">Propulsion</span><span class="o">.</span><span class="n">TOTAL_SCALED_SLS_THRUST</span><span class="p">),</span>
                             <span class="p">(</span><span class="s1">&#39;takeoff_mass&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">)],</span>
            <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;TW_ratio&#39;</span><span class="p">,</span> <span class="n">Aircraft</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">THRUST_TO_WEIGHT_RATIO</span><span class="p">)],</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cruise_alt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span>
            <span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">CRUISE_ALTITUDE</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;ft&#39;</span><span class="p">)</span>

        <span class="c1"># Add taxi subsystem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="s2">&quot;taxi&quot;</span><span class="p">,</span> <span class="n">TaxiSegment</span><span class="p">(</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ode_args</span><span class="p">)),</span>
            <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;aircraft:*&#39;</span><span class="p">,</span> <span class="s1">&#39;mission:*&#39;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">COLLOCATION</span><span class="p">:</span>
            <span class="c1"># Add event transformation subsystem</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
                <span class="s2">&quot;event_xform&quot;</span><span class="p">,</span>
                <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;t_init_gear=m*tau_gear+b&quot;</span><span class="p">,</span> <span class="s2">&quot;t_init_flaps=m*tau_flaps+b&quot;</span><span class="p">],</span>
                    <span class="n">t_init_gear</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;s&quot;</span><span class="p">},</span>
                    <span class="n">t_init_flaps</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;s&quot;</span><span class="p">},</span>
                    <span class="n">tau_gear</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;unitless&quot;</span><span class="p">},</span>
                    <span class="n">tau_flaps</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;unitless&quot;</span><span class="p">},</span>
                    <span class="n">m</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;s&quot;</span><span class="p">},</span>
                    <span class="n">b</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;s&quot;</span><span class="p">},</span>
                <span class="p">),</span>
                <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span>
                    <span class="s2">&quot;tau_gear&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;tau_flaps&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Takeoff</span><span class="o">.</span><span class="n">ASCENT_DURATION</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Takeoff</span><span class="o">.</span><span class="n">ASCENT_T_INTIIAL</span><span class="p">),</span>
                <span class="p">],</span>
                <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;t_init_gear&quot;</span><span class="p">,</span> <span class="s2">&quot;t_init_flaps&quot;</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="c1"># Calculate speed at which to initiate rotation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="s2">&quot;vrot&quot;</span><span class="p">,</span>
            <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
                <span class="s2">&quot;Vrot = ((2 * mass * g) / (rho * wing_area * CLmax))**0.5 + dV1 + dVR&quot;</span><span class="p">,</span>
                <span class="n">Vrot</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;ft/s&quot;</span><span class="p">},</span>
                <span class="n">mass</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;lbm&quot;</span><span class="p">},</span>
                <span class="n">CLmax</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;unitless&quot;</span><span class="p">},</span>
                <span class="n">g</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;lbf/lbm&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">GRAV_ENGLISH_LBM</span><span class="p">},</span>
                <span class="n">rho</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;slug/ft**3&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">RHO_SEA_LEVEL_ENGLISH</span><span class="p">},</span>
                <span class="n">wing_area</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;ft**2&quot;</span><span class="p">},</span>
                <span class="n">dV1</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;ft/s&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Increment of engine failure decision speed above stall&quot;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">dVR</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;ft/s&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Increment of takeoff rotation speed above engine failure &quot;</span>
                    <span class="s2">&quot;decision speed&quot;</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">),</span>
            <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;wing_area&quot;</span><span class="p">,</span> <span class="n">Aircraft</span><span class="o">.</span><span class="n">Wing</span><span class="o">.</span><span class="n">AREA</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;dV1&quot;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Takeoff</span><span class="o">.</span><span class="n">DECISION_SPEED_INCREMENT</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;dVR&quot;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Takeoff</span><span class="o">.</span><span class="n">ROTATION_SPEED_INCREMENT</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;CLmax&quot;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Takeoff</span><span class="o">.</span><span class="n">LIFT_COEFFICIENT_MAX</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;Vrot&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Takeoff</span><span class="o">.</span><span class="n">ROTATION_VELOCITY</span><span class="p">)]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_premission_external_subsystems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This private method adds each external subsystem to the pre-mission subsystem and</span>
<span class="sd">        a mass component that captures external subsystem masses for use in mass buildups.</span>

<span class="sd">        Firstly, the method iterates through all external subsystems in the pre-mission</span>
<span class="sd">        information. For each subsystem, it builds the pre-mission instance of the</span>
<span class="sd">        subsystem.</span>

<span class="sd">        Secondly, the method collects the mass names of the added subsystems. This</span>
<span class="sd">        expression is then used to define an ExecComp (a component that evaluates a</span>
<span class="sd">        simple equation given input values).</span>

<span class="sd">        The method promotes the input and output of this ExecComp to the top level of the</span>
<span class="sd">        pre-mission object, allowing this calculated subsystem mass to be accessed</span>
<span class="sd">        directly from the pre-mission object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">mass_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Loop through all the phases in this subsystem.</span>
        <span class="k">for</span> <span class="n">external_subsystem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission_info</span><span class="p">[</span><span class="s1">&#39;external_subsystems&#39;</span><span class="p">]:</span>
            <span class="c1"># Get all the subsystem builders for this phase.</span>
            <span class="n">subsystem_premission</span> <span class="o">=</span> <span class="n">external_subsystem</span><span class="o">.</span><span class="n">build_pre_mission</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">subsystem_premission</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="n">external_subsystem</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                               <span class="n">subsystem_premission</span><span class="p">)</span>

                <span class="n">mass_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">external_subsystem</span><span class="o">.</span><span class="n">get_mass_names</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">mass_names</span><span class="p">:</span>
            <span class="n">formatted_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">mass_names</span><span class="p">:</span>
                <span class="n">formatted_name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
                <span class="n">formatted_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">formatted_name</span><span class="p">)</span>

            <span class="c1"># Define the expression for computing the sum of masses</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="s1">&#39;subsystem_mass = &#39;</span> <span class="o">+</span> <span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formatted_names</span><span class="p">)</span>

            <span class="n">promotes_inputs_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">formatted_name</span><span class="p">,</span> <span class="n">original_name</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">formatted_name</span><span class="p">,</span> <span class="n">original_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">formatted_names</span><span class="p">,</span> <span class="n">mass_names</span><span class="p">)]</span>

            <span class="c1"># Create the ExecComp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;external_comp_sum&#39;</span><span class="p">,</span> <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;kg&#39;</span><span class="p">),</span>
                                           <span class="n">promotes_inputs</span><span class="o">=</span><span class="n">promotes_inputs_list</span><span class="p">,</span>
                                           <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;subsystem_mass&#39;</span><span class="p">,</span> <span class="n">Aircraft</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">EXTERNAL_SUBSYSTEMS_MASS</span><span class="p">)])</span>

    <span class="k">def</span> <span class="nf">_add_groundroll_eq_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add an equality constraint to the problem to ensure that the TAS at the end of the</span>
<span class="sd">        groundroll phase is equal to the rotation velocity at the start of the rotation phase.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="s2">&quot;groundroll_boundary&quot;</span><span class="p">,</span>
            <span class="n">om</span><span class="o">.</span><span class="n">EQConstraintComp</span><span class="p">(</span>
                <span class="s2">&quot;velocity&quot;</span><span class="p">,</span>
                <span class="n">eq_units</span><span class="o">=</span><span class="s2">&quot;ft/s&quot;</span><span class="p">,</span>
                <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">add_constraint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Takeoff</span><span class="o">.</span><span class="n">ROTATION_VELOCITY</span><span class="p">,</span>
                           <span class="s2">&quot;groundroll_boundary.rhs:velocity&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="s2">&quot;traj.groundroll.states:velocity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;groundroll_boundary.lhs:velocity&quot;</span><span class="p">,</span>
            <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">flat_src_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ascent_tx</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;transcription&quot;</span><span class="p">]</span>
        <span class="n">ascent_num_nodes</span> <span class="o">=</span> <span class="n">ascent_tx</span><span class="o">.</span><span class="n">grid_data</span><span class="o">.</span><span class="n">num_nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="s2">&quot;h_fit&quot;</span><span class="p">,</span>
            <span class="n">PolynomialFit</span><span class="p">(</span><span class="n">N_cp</span><span class="o">=</span><span class="n">ascent_num_nodes</span><span class="p">),</span>
            <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;t_init_gear&quot;</span><span class="p">,</span> <span class="s2">&quot;t_init_flaps&quot;</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase_idx</span><span class="p">):</span>
        <span class="n">base_phase_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span>

        <span class="c1"># We need to exclude some things from the phase_options that we pass down</span>
        <span class="c1"># to the phases. Intead of &quot;popping&quot; keys, we just create new outer dictionaries.</span>

        <span class="n">phase_options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">base_phase_options</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">phase_options</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="n">phase_options</span><span class="p">[</span><span class="s1">&#39;user_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">base_phase_options</span><span class="p">[</span><span class="s1">&#39;user_options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">phase_options</span><span class="p">[</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="c1"># TODO optionally accept which subsystems to load from phase_info</span>
        <span class="n">subsystems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">core_subsystems</span>
        <span class="n">default_mission_subsystems</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">subsystems</span><span class="p">[</span><span class="s1">&#39;aerodynamics&#39;</span><span class="p">],</span> <span class="n">subsystems</span><span class="p">[</span><span class="s1">&#39;propulsion&#39;</span><span class="p">]]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;groundroll&#39;</span> <span class="ow">in</span> <span class="n">phase_name</span><span class="p">:</span>
                <span class="n">phase_builder</span> <span class="o">=</span> <span class="n">GroundrollPhase</span>
            <span class="k">elif</span> <span class="s1">&#39;rotation&#39;</span> <span class="ow">in</span> <span class="n">phase_name</span><span class="p">:</span>
                <span class="n">phase_builder</span> <span class="o">=</span> <span class="n">RotationPhase</span>
            <span class="k">elif</span> <span class="s1">&#39;accel&#39;</span> <span class="ow">in</span> <span class="n">phase_name</span><span class="p">:</span>
                <span class="n">phase_builder</span> <span class="o">=</span> <span class="n">AccelPhase</span>
            <span class="k">elif</span> <span class="s1">&#39;ascent&#39;</span> <span class="ow">in</span> <span class="n">phase_name</span><span class="p">:</span>
                <span class="n">phase_builder</span> <span class="o">=</span> <span class="n">AscentPhase</span>
            <span class="k">elif</span> <span class="s1">&#39;climb&#39;</span> <span class="ow">in</span> <span class="n">phase_name</span><span class="p">:</span>
                <span class="n">phase_builder</span> <span class="o">=</span> <span class="n">ClimbPhase</span>
            <span class="k">elif</span> <span class="s1">&#39;cruise&#39;</span> <span class="ow">in</span> <span class="n">phase_name</span><span class="p">:</span>
                <span class="n">phase_builder</span> <span class="o">=</span> <span class="n">CruisePhase</span>
            <span class="k">elif</span> <span class="s1">&#39;desc&#39;</span> <span class="ow">in</span> <span class="n">phase_name</span><span class="p">:</span>
                <span class="n">phase_builder</span> <span class="o">=</span> <span class="n">DescentPhase</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1"> does not have an associated phase_builder </span><span class="se">\n</span><span class="s1"> phase_name must &#39;</span>
                    <span class="s1">&#39;include one of: groundroll, rotation, accel, ascent, climb, cruise, or desc&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">HEIGHT_ENERGY</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;phase_builder&#39;</span> <span class="ow">in</span> <span class="n">phase_options</span><span class="p">:</span>
                <span class="n">phase_builder</span> <span class="o">=</span> <span class="n">phase_options</span><span class="p">[</span><span class="s1">&#39;phase_builder&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">phase_builder</span><span class="p">,</span> <span class="n">PhaseBuilderBase</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;phase_builder for the phase called </span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2"> must be a PhaseBuilderBase object.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">phase_builder</span> <span class="o">=</span> <span class="n">EnergyPhase</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">SOLVED_2DOF</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">phase_options</span><span class="p">[</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="s1">&#39;ground_roll&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">phase_options</span><span class="p">[</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="s1">&#39;fix_initial&#39;</span><span class="p">]:</span>
                <span class="n">phase_builder</span> <span class="o">=</span> <span class="n">GroundrollPhaseVelocityIntegrated</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">phase_builder</span> <span class="o">=</span> <span class="n">TwoDOFPhase</span>

        <span class="n">phase_object</span> <span class="o">=</span> <span class="n">phase_builder</span><span class="o">.</span><span class="n">from_phase_info</span><span class="p">(</span>
            <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase_options</span><span class="p">,</span> <span class="n">default_mission_subsystems</span><span class="p">,</span> <span class="n">meta_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">)</span>

        <span class="n">phase</span> <span class="o">=</span> <span class="n">phase_object</span><span class="o">.</span><span class="n">build_phase</span><span class="p">(</span><span class="n">aviary_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">phase_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_object</span><span class="p">)</span>

        <span class="c1"># TODO: add logic to filter which phases get which controls.</span>
        <span class="c1"># right now all phases get all controls added from every subsystem.</span>
        <span class="c1"># for example, we might only want ELECTRIC_SHAFT_POWER applied during the climb phase.</span>
        <span class="n">all_subsystems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_subsystems</span><span class="p">(</span>
            <span class="n">phase_options</span><span class="p">[</span><span class="s1">&#39;external_subsystems&#39;</span><span class="p">])</span>

        <span class="c1"># loop through all_subsystems and call `get_controls` on each subsystem</span>
        <span class="k">for</span> <span class="n">subsystem</span> <span class="ow">in</span> <span class="n">all_subsystems</span><span class="p">:</span>
            <span class="c1"># add the controls from the subsystems to each phase</span>
            <span class="n">arg_spec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">subsystem</span><span class="o">.</span><span class="n">get_controls</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;phase_name&#39;</span> <span class="ow">in</span> <span class="n">arg_spec</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">control_dicts</span> <span class="o">=</span> <span class="n">subsystem</span><span class="o">.</span><span class="n">get_controls</span><span class="p">(</span>
                    <span class="n">phase_name</span><span class="o">=</span><span class="n">phase_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">control_dicts</span> <span class="o">=</span> <span class="n">subsystem</span><span class="o">.</span><span class="n">get_controls</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">control_name</span><span class="p">,</span> <span class="n">control_dict</span> <span class="ow">in</span> <span class="n">control_dicts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">phase</span><span class="o">.</span><span class="n">add_control</span><span class="p">(</span><span class="n">control_name</span><span class="p">,</span> <span class="o">**</span><span class="n">control_dict</span><span class="p">)</span>

        <span class="n">user_options</span> <span class="o">=</span> <span class="n">AviaryValues</span><span class="p">(</span><span class="n">phase_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_options&#39;</span><span class="p">,</span> <span class="p">()))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">fix_initial</span> <span class="o">=</span> <span class="n">user_options</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="s1">&#39;fix_initial&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">fix_intial</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">fix_duration</span> <span class="o">=</span> <span class="n">user_options</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="s1">&#39;fix_duration&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">fix_duration</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s1">&#39;ascent&#39;</span> <span class="ow">in</span> <span class="n">phase_name</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">:</span>
            <span class="n">phase</span><span class="o">.</span><span class="n">set_time_options</span><span class="p">(</span>
                <span class="n">units</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span>
                <span class="n">targets</span><span class="o">=</span><span class="s2">&quot;t_curr&quot;</span><span class="p">,</span>
                <span class="n">input_initial</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">input_duration</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;cruise&#39;</span> <span class="ow">in</span> <span class="n">phase_name</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">:</span>
            <span class="c1"># Time here is really the independent variable through which we are integrating.</span>
            <span class="c1"># In the case of the Breguet Range ODE, it&#39;s mass.</span>
            <span class="c1"># We rely on mass being monotonically non-increasing across the phase.</span>
            <span class="n">phase</span><span class="o">.</span><span class="n">set_time_options</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mass&#39;</span><span class="p">,</span>
                <span class="n">fix_initial</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">fix_duration</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">units</span><span class="o">=</span><span class="s2">&quot;lbm&quot;</span><span class="p">,</span>
                <span class="n">targets</span><span class="o">=</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span>
                <span class="n">initial_bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.e7</span><span class="p">),</span>
                <span class="n">initial_ref</span><span class="o">=</span><span class="mf">100.e3</span><span class="p">,</span>
                <span class="n">duration_bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.e7</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">duration_ref</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;descent&#39;</span> <span class="ow">in</span> <span class="n">phase_name</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">:</span>
            <span class="n">duration_ref</span> <span class="o">=</span> <span class="n">user_options</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="s2">&quot;duration_ref&quot;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span>
            <span class="n">phase</span><span class="o">.</span><span class="n">set_time_options</span><span class="p">(</span>
                <span class="n">duration_bounds</span><span class="o">=</span><span class="n">duration_bounds</span><span class="p">,</span>
                <span class="n">fix_initial</span><span class="o">=</span><span class="n">fix_initial</span><span class="p">,</span>
                <span class="n">input_initial</span><span class="o">=</span><span class="n">input_initial</span><span class="p">,</span>
                <span class="n">units</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span>
                <span class="n">duration_ref</span><span class="o">=</span><span class="n">duration_ref</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># The rest of the phases includes all Height Energy method phases</span>
            <span class="c1"># and any 2DOF phases that don&#39;t fall into the naming patterns</span>
            <span class="c1"># above.</span>
            <span class="n">input_initial</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">time_units</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">time_options</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>

            <span class="c1"># Make a good guess for a reasonable intitial time scaler.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">initial_bounds</span> <span class="o">=</span> <span class="n">user_options</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="s1">&#39;initial_bounds&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">time_units</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">initial_bounds</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">initial_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">initial_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="c1"># Upper bound is good for a ref.</span>
                <span class="n">user_options</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="s1">&#39;initial_ref&#39;</span><span class="p">,</span> <span class="n">initial_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                     <span class="n">units</span><span class="o">=</span><span class="n">time_units</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">user_options</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="s1">&#39;initial_ref&#39;</span><span class="p">,</span> <span class="mf">600.</span><span class="p">,</span> <span class="n">time_units</span><span class="p">)</span>

            <span class="n">duration_bounds</span> <span class="o">=</span> <span class="n">user_options</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="s2">&quot;duration_bounds&quot;</span><span class="p">,</span> <span class="n">time_units</span><span class="p">)</span>
            <span class="n">user_options</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span>
                <span class="s1">&#39;duration_ref&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">duration_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">duration_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span>
                <span class="n">time_units</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">phase_idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">input_initial</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">fix_initial</span> <span class="ow">or</span> <span class="n">input_initial</span><span class="p">:</span>
                <span class="n">phase</span><span class="o">.</span><span class="n">set_time_options</span><span class="p">(</span>
                    <span class="n">fix_initial</span><span class="o">=</span><span class="n">fix_initial</span><span class="p">,</span> <span class="n">fix_duration</span><span class="o">=</span><span class="n">fix_duration</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">time_units</span><span class="p">,</span>
                    <span class="n">duration_bounds</span><span class="o">=</span><span class="n">user_options</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="s2">&quot;duration_bounds&quot;</span><span class="p">,</span> <span class="n">time_units</span><span class="p">),</span>
                    <span class="n">duration_ref</span><span class="o">=</span><span class="n">user_options</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="s2">&quot;duration_ref&quot;</span><span class="p">,</span> <span class="n">time_units</span><span class="p">),</span>
                    <span class="n">initial_ref</span><span class="o">=</span><span class="n">user_options</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="s2">&quot;initial_ref&quot;</span><span class="p">,</span> <span class="n">time_units</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">phase_name</span> <span class="o">==</span> <span class="s1">&#39;descent&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">HEIGHT_ENERGY</span><span class="p">:</span>  <span class="c1"># TODO: generalize this logic for all phases</span>
                <span class="n">phase</span><span class="o">.</span><span class="n">set_time_options</span><span class="p">(</span>
                    <span class="n">fix_initial</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fix_duration</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">time_units</span><span class="p">,</span>
                    <span class="n">duration_bounds</span><span class="o">=</span><span class="n">user_options</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="s2">&quot;duration_bounds&quot;</span><span class="p">,</span> <span class="n">time_units</span><span class="p">),</span>
                    <span class="n">duration_ref</span><span class="o">=</span><span class="n">user_options</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="s2">&quot;duration_ref&quot;</span><span class="p">,</span> <span class="n">time_units</span><span class="p">),</span>
                    <span class="n">initial_bounds</span><span class="o">=</span><span class="n">initial_bounds</span><span class="p">,</span>
                    <span class="n">initial_ref</span><span class="o">=</span><span class="n">user_options</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="s2">&quot;initial_ref&quot;</span><span class="p">,</span> <span class="n">time_units</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># TODO: figure out how to handle this now that fix_initial is dict</span>
                <span class="n">phase</span><span class="o">.</span><span class="n">set_time_options</span><span class="p">(</span>
                    <span class="n">fix_initial</span><span class="o">=</span><span class="n">fix_initial</span><span class="p">,</span> <span class="n">fix_duration</span><span class="o">=</span><span class="n">fix_duration</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">time_units</span><span class="p">,</span>
                    <span class="n">duration_bounds</span><span class="o">=</span><span class="n">user_options</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="s2">&quot;duration_bounds&quot;</span><span class="p">,</span> <span class="n">time_units</span><span class="p">),</span>
                    <span class="n">duration_ref</span><span class="o">=</span><span class="n">user_options</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="s2">&quot;duration_ref&quot;</span><span class="p">,</span> <span class="n">time_units</span><span class="p">),</span>
                    <span class="n">initial_bounds</span><span class="o">=</span><span class="n">initial_bounds</span><span class="p">,</span>
                    <span class="n">initial_ref</span><span class="o">=</span><span class="n">user_options</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="s2">&quot;initial_ref&quot;</span><span class="p">,</span> <span class="n">time_units</span><span class="p">),</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;cruise&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">phase_name</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">:</span>
            <span class="n">phase</span><span class="o">.</span><span class="n">add_control</span><span class="p">(</span>
                <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">THROTTLE</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">THROTTLE</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;unitless&#39;</span><span class="p">,</span>
                <span class="n">opt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">phase</span>

<div class="viewcode-block" id="AviaryProblem.add_phases">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.add_phases">[docs]</a>
    <span class="k">def</span> <span class="nf">add_phases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_info_parameterization</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the mission phases to the problem trajectory based on the user-specified</span>
<span class="sd">        phase_info dictionary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        phase_info_parameterization (function, optional): A function that takes in the phase_info dictionary</span>
<span class="sd">            and aviary_inputs and returns modified aviary_inputs. Defaults to None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        traj: The Dymos Trajectory object containing the added mission phases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">phase_info_parameterization</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_mission_info</span> <span class="o">=</span> <span class="n">phase_info_parameterization</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">,</span>
                                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">post_mission_info</span><span class="p">,</span>
                                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="p">)</span>

        <span class="n">phase_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span>

        <span class="n">phases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phase_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">COLLOCATION</span><span class="p">:</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;traj&#39;</span><span class="p">,</span> <span class="n">dm</span><span class="o">.</span><span class="n">Trajectory</span><span class="p">())</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">SHOOTING</span><span class="p">:</span>
            <span class="n">initial_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">,</span> <span class="s1">&#39;lbm&#39;</span><span class="p">)</span>

            <span class="n">ascent_phases</span> <span class="o">=</span> <span class="n">create_2dof_based_ascent_phases</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ode_args</span><span class="p">,</span>
                <span class="n">cruise_alt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cruise_alt</span><span class="p">,</span>
                <span class="n">cruise_mach</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cruise_mach</span><span class="p">)</span>

            <span class="n">descent_phases</span> <span class="o">=</span> <span class="n">create_2dof_based_descent_phases</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ode_args</span><span class="p">,</span>
                <span class="n">cruise_mach</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cruise_mach</span><span class="p">)</span>

            <span class="n">descent_estimation</span> <span class="o">=</span> <span class="n">descent_range_and_fuel</span><span class="p">(</span>
                <span class="n">phases</span><span class="o">=</span><span class="n">descent_phases</span><span class="p">,</span>
                <span class="n">initial_mass</span><span class="o">=</span><span class="n">initial_mass</span><span class="p">,</span>
                <span class="n">cruise_alt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cruise_alt</span><span class="p">,</span>
                <span class="n">cruise_mach</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cruise_mach</span><span class="p">)</span>

            <span class="n">estimated_descent_range</span> <span class="o">=</span> <span class="n">descent_estimation</span><span class="p">[</span><span class="s1">&#39;refined_guess&#39;</span><span class="p">][</span><span class="s1">&#39;distance_flown&#39;</span><span class="p">]</span>
            <span class="n">end_of_cruise_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_range</span> <span class="o">-</span> <span class="n">estimated_descent_range</span>

            <span class="c1"># based on reserve_fuel</span>
            <span class="n">estimated_descent_fuel</span> <span class="o">=</span> <span class="n">descent_estimation</span><span class="p">[</span><span class="s1">&#39;refined_guess&#39;</span><span class="p">][</span><span class="s1">&#39;fuel_burned&#39;</span><span class="p">]</span>

            <span class="n">cruise_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">input_speed_type</span><span class="o">=</span><span class="n">SpeedType</span><span class="o">.</span><span class="n">MACH</span><span class="p">,</span>
                <span class="n">input_speed_units</span><span class="o">=</span><span class="s2">&quot;unitless&quot;</span><span class="p">,</span>
                <span class="n">ode_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ode_args</span><span class="p">,</span>
                <span class="n">alpha_mode</span><span class="o">=</span><span class="n">AlphaModes</span><span class="o">.</span><span class="n">REQUIRED_LIFT</span><span class="p">,</span>
                <span class="n">simupy_args</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">verbosity</span><span class="o">=</span><span class="n">Verbosity</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">cruise_vals</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;mach&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cruise_mach</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">cruise_kwargs</span><span class="p">[</span><span class="s1">&#39;input_speed_units&#39;</span><span class="p">]},</span>
                <span class="s1">&#39;descent_fuel&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">estimated_descent_fuel</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
            <span class="p">}</span>

            <span class="n">phases</span> <span class="o">=</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">ascent_phases</span><span class="p">,</span>
                <span class="s1">&#39;cruise&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;ode&#39;</span><span class="p">:</span> <span class="n">SGMCruise</span><span class="p">(</span><span class="o">**</span><span class="n">cruise_kwargs</span><span class="p">),</span>
                    <span class="s1">&#39;vals_to_set&#39;</span><span class="p">:</span> <span class="n">cruise_vals</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="o">**</span><span class="n">descent_phases</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">full_traj</span> <span class="o">=</span> <span class="n">FlexibleTraj</span><span class="p">(</span>
                <span class="n">Phases</span><span class="o">=</span><span class="n">phases</span><span class="p">,</span>
                <span class="n">traj_final_state_output</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">MASS</span><span class="p">,</span>
                    <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">DISTANCE</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">traj_initial_state_input</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">MASS</span><span class="p">,</span>
                    <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">DISTANCE</span><span class="p">,</span>
                    <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">ALTITUDE</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">traj_event_trigger_input</span><span class="o">=</span><span class="p">[</span>
                    <span class="c1"># specify ODE, output_name, with units that SimuPyProblem expects</span>
                    <span class="c1"># assume event function is of form ODE.output_name - value</span>
                    <span class="c1"># third key is event_idx associated with input</span>
                    <span class="p">(</span><span class="n">phases</span><span class="p">[</span><span class="s1">&#39;groundroll&#39;</span><span class="p">][</span><span class="s1">&#39;ode&#39;</span><span class="p">],</span> <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">VELOCITY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,),</span>
                    <span class="p">(</span><span class="n">phases</span><span class="p">[</span><span class="s1">&#39;climb3&#39;</span><span class="p">][</span><span class="s1">&#39;ode&#39;</span><span class="p">],</span> <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">ALTITUDE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,),</span>
                    <span class="p">(</span><span class="n">phases</span><span class="p">[</span><span class="s1">&#39;cruise&#39;</span><span class="p">][</span><span class="s1">&#39;ode&#39;</span><span class="p">],</span> <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">MASS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,),</span>
                <span class="p">],</span>
            <span class="p">)</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;traj&#39;</span><span class="p">,</span> <span class="n">full_traj</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">traj</span>

        <span class="k">def</span> <span class="nf">add_subsystem_timeseries_outputs</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">):</span>
            <span class="n">phase_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span>
            <span class="n">all_subsystems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_subsystems</span><span class="p">(</span>
                <span class="n">phase_options</span><span class="p">[</span><span class="s1">&#39;external_subsystems&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">subsystem</span> <span class="ow">in</span> <span class="n">all_subsystems</span><span class="p">:</span>
                <span class="n">timeseries_to_add</span> <span class="o">=</span> <span class="n">subsystem</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">timeseries</span> <span class="ow">in</span> <span class="n">timeseries_to_add</span><span class="p">:</span>
                    <span class="n">phase</span><span class="o">.</span><span class="n">add_timeseries_output</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">in</span> <span class="p">(</span><span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">,</span> <span class="n">HEIGHT_ENERGY</span><span class="p">,</span> <span class="n">SOLVED_2DOF</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">COLLOCATION</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">phase_objects</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">phase_idx</span><span class="p">,</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phases</span><span class="p">):</span>
                    <span class="n">phase</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">add_phase</span><span class="p">(</span>
                        <span class="n">phase_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_phase</span><span class="p">(</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">phase_idx</span><span class="p">))</span>
                    <span class="n">add_subsystem_timeseries_outputs</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">phase_name</span> <span class="o">==</span> <span class="s1">&#39;ascent&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_add_groundroll_eq_constraint</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>

            <span class="c1"># loop through phase_info and external subsystems</span>
            <span class="n">external_parameters</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">:</span>
                <span class="n">external_parameters</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">all_subsystems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_subsystems</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;external_subsystems&#39;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">subsystem</span> <span class="ow">in</span> <span class="n">all_subsystems</span><span class="p">:</span>
                    <span class="n">parameter_dict</span> <span class="o">=</span> <span class="n">subsystem</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">parameter_dict</span><span class="p">:</span>
                        <span class="n">external_parameters</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter_dict</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">in</span> <span class="p">(</span><span class="n">HEIGHT_ENERGY</span><span class="p">,</span> <span class="n">SOLVED_2DOF</span><span class="p">):</span>
                <span class="n">traj</span> <span class="o">=</span> <span class="n">setup_trajectory_params</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="p">,</span> <span class="n">phases</span><span class="p">,</span> <span class="n">meta_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">,</span> <span class="n">external_parameters</span><span class="o">=</span><span class="n">external_parameters</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">traj</span> <span class="o">=</span> <span class="n">traj</span>

        <span class="k">return</span> <span class="n">traj</span></div>


<div class="viewcode-block" id="AviaryProblem.add_post_mission_systems">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.add_post_mission_systems">[docs]</a>
    <span class="k">def</span> <span class="nf">add_post_mission_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_landing</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add post-mission systems to the aircraft model. This is akin to the statics group</span>
<span class="sd">        or the &quot;premission_systems&quot;, but occurs after the mission in the execution order.</span>

<span class="sd">        Depending on the mission model specified (`FLOPS` or `GASP`), this method adds various subsystems</span>
<span class="sd">        to the aircraft model. For the `FLOPS` mission model, a landing phase is added using the Landing class</span>
<span class="sd">        with the wing area and lift coefficient specified, and a takeoff constraints ExecComp is added to enforce</span>
<span class="sd">        mass, range, velocity, and altitude continuity between the takeoff and climb phases. The landing subsystem</span>
<span class="sd">        is promoted with aircraft and mission inputs and outputs as appropriate, while the takeoff constraints ExecComp</span>
<span class="sd">        is only promoted with mission inputs and outputs.</span>

<span class="sd">        For the `GASP` mission model, four subsystems are added: a LandingSegment subsystem, an ExecComp to calculate</span>
<span class="sd">        the reserve fuel required, an ExecComp to calculate the overall fuel burn, and three ExecComps to calculate</span>
<span class="sd">        various mission objectives and constraints. All subsystems are promoted with aircraft and mission inputs and</span>
<span class="sd">        outputs as appropriate.</span>

<span class="sd">        A user can override this with their own postmission systems.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission_info</span><span class="p">[</span><span class="s1">&#39;include_takeoff&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">HEIGHT_ENERGY</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_post_mission_takeoff_systems</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">include_landing</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_mission_info</span><span class="p">[</span><span class="s1">&#39;include_landing&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">HEIGHT_ENERGY</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_height_energy_landing_systems</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_two_dof_landing_systems</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;post_mission&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span><span class="p">,</span>
                                 <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">],</span>
                                 <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">])</span>

        <span class="c1"># Loop through all the phases in this subsystem.</span>
        <span class="k">for</span> <span class="n">external_subsystem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_mission_info</span><span class="p">[</span><span class="s1">&#39;external_subsystems&#39;</span><span class="p">]:</span>
            <span class="c1"># Get all the subsystem builders for this phase.</span>
            <span class="n">subsystem_postmission</span> <span class="o">=</span> <span class="n">external_subsystem</span><span class="o">.</span><span class="n">build_post_mission</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">subsystem_postmission</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="n">external_subsystem</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                <span class="n">subsystem_postmission</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">in</span> <span class="p">(</span><span class="n">HEIGHT_ENERGY</span><span class="p">,</span> <span class="n">SOLVED_2DOF</span><span class="p">,</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">):</span>
            <span class="c1"># Check if regular_phases[] is accessible</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">regular_phases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;regular_phases[] dictionary is not accessible.&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; For HEIGHT_ENERGY and SOLVED_2DOF missions, check_and_preprocess_inputs()&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; must be called before add_post_mission_systems().&quot;</span><span class="p">)</span>

            <span class="c1"># Fuel burn in regular phases</span>
            <span class="n">ecomp</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span><span class="s1">&#39;fuel_burned = initial_mass - mass_final&#39;</span><span class="p">,</span>
                                <span class="n">initial_mass</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
                                <span class="n">mass_final</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
                                <span class="n">fuel_burned</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">})</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;fuel_burned&#39;</span><span class="p">,</span> <span class="n">ecomp</span><span class="p">,</span>
                                            <span class="n">promotes</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;fuel_burned&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">FUEL_BURNED</span><span class="p">)])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">SHOOTING</span><span class="p">:</span>
                <span class="c1"># shooting method currently doesn&#39;t have timeseries</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span><span class="o">.</span><span class="n">promotes</span><span class="p">(</span><span class="s1">&#39;fuel_burned&#39;</span><span class="p">,</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;initial_mass&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;mass_final&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Landing</span><span class="o">.</span><span class="n">TOUCHDOWN_MASS</span><span class="p">),</span>
                <span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># timeseries has to be used because Breguet cruise phases don&#39;t have states</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;traj.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">regular_phases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.timeseries.mass&quot;</span><span class="p">,</span>
                                   <span class="s2">&quot;fuel_burned.initial_mass&quot;</span><span class="p">,</span> <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;traj.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">regular_phases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">.timeseries.mass&quot;</span><span class="p">,</span>
                                   <span class="s2">&quot;fuel_burned.mass_final&quot;</span><span class="p">,</span> <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># Fuel burn in reserve phases</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserve_phases</span><span class="p">:</span>
                <span class="n">ecomp</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span><span class="s1">&#39;reserve_fuel_burned = initial_mass - mass_final&#39;</span><span class="p">,</span>
                                    <span class="n">initial_mass</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
                                    <span class="n">mass_final</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
                                    <span class="n">reserve_fuel_burned</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">})</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;reserve_fuel_burned&#39;</span><span class="p">,</span> <span class="n">ecomp</span><span class="p">,</span>
                                                <span class="n">promotes</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;reserve_fuel_burned&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">RESERVE_FUEL_BURNED</span><span class="p">)])</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">SHOOTING</span><span class="p">:</span>
                    <span class="c1"># shooting method currently doesn&#39;t have timeseries</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span><span class="o">.</span><span class="n">promotes</span><span class="p">(</span><span class="s1">&#39;reserve_fuel_burned&#39;</span><span class="p">,</span> <span class="p">[</span>
                        <span class="p">(</span><span class="s1">&#39;initial_mass&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Landing</span><span class="o">.</span><span class="n">TOUCHDOWN_MASS</span><span class="p">),</span>
                    <span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;traj.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reserve_phases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">.states:mass&quot;</span><span class="p">,</span>
                                       <span class="s2">&quot;reserve_fuel_burned.mass_final&quot;</span><span class="p">,</span> <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># timeseries has to be used because Breguet cruise phases don&#39;t have states</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;traj.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reserve_phases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.timeseries.mass&quot;</span><span class="p">,</span>
                                       <span class="s2">&quot;reserve_fuel_burned.initial_mass&quot;</span><span class="p">,</span> <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;traj.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reserve_phases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">.timeseries.mass&quot;</span><span class="p">,</span>
                                       <span class="s2">&quot;reserve_fuel_burned.mass_final&quot;</span><span class="p">,</span> <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">SHOOTING</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_fuel_reserve_component</span><span class="p">()</span>

            <span class="c1"># TODO: need to add some sort of check that this value is less than the fuel capacity</span>
            <span class="c1"># TODO: the overall_fuel variable is the burned fuel plus the reserve, but should</span>
            <span class="c1"># also include the unused fuel, and the hierarchy variable name should be more clear</span>
            <span class="n">ecomp</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span><span class="s1">&#39;overall_fuel = (1 + fuel_margin/100)*fuel_burned + reserve_fuel&#39;</span><span class="p">,</span>
                                <span class="n">overall_fuel</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                                <span class="n">fuel_margin</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;unitless&quot;</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                                <span class="n">fuel_burned</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>  <span class="c1"># from regular_phases only</span>
                                <span class="n">reserve_fuel</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
                <span class="s1">&#39;fuel_calc&#39;</span><span class="p">,</span> <span class="n">ecomp</span><span class="p">,</span>
                <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span>
                    <span class="p">(</span><span class="s2">&quot;fuel_margin&quot;</span><span class="p">,</span> <span class="n">Aircraft</span><span class="o">.</span><span class="n">Fuel</span><span class="o">.</span><span class="n">FUEL_MARGIN</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;fuel_burned&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">FUEL_BURNED</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;reserve_fuel&quot;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">RESERVE_FUEL</span><span class="p">),</span>
                <span class="p">],</span>
                <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;overall_fuel&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">TOTAL_FUEL_MASS</span><span class="p">)])</span>

            <span class="c1"># If a target range has been specified</span>
            <span class="c1"># range is measured from the start of the first phase to the end of the last normal phase</span>
            <span class="k">if</span> <span class="s1">&#39;target_range&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_mission_info</span><span class="p">:</span>
                <span class="n">target_range</span> <span class="o">=</span> <span class="n">wrapped_convert_units</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">post_mission_info</span><span class="p">[</span><span class="s1">&#39;target_range&#39;</span><span class="p">],</span> <span class="s1">&#39;nmi&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
                    <span class="s2">&quot;range_constraint&quot;</span><span class="p">,</span>
                    <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
                        <span class="s2">&quot;range_resid = target_range - actual_range&quot;</span><span class="p">,</span>
                        <span class="n">range_resid</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;nmi&#39;</span><span class="p">},</span>
                        <span class="n">actual_range</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;nmi&#39;</span><span class="p">},</span>
                        <span class="n">target_range</span><span class="o">=</span><span class="p">{</span>
                            <span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">target_range</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;nmi&#39;</span><span class="p">},</span>
                    <span class="p">),</span>
                    <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[</span>
                        <span class="p">(</span><span class="s2">&quot;range_resid&quot;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Constraints</span><span class="o">.</span><span class="n">RANGE_RESIDUAL</span><span class="p">)],</span>
                <span class="p">)</span>

                <span class="c1"># determine distance traveled based on regular_phases</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;traj.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">regular_phases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">.timeseries.distance&quot;</span><span class="p">,</span> <span class="s2">&quot;range_constraint.actual_range&quot;</span><span class="p">,</span> <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span>
                    <span class="n">Mission</span><span class="o">.</span><span class="n">Constraints</span><span class="o">.</span><span class="n">RANGE_RESIDUAL</span><span class="p">,</span> <span class="n">equals</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mf">1.e2</span><span class="p">)</span>

            <span class="c1"># If a target distance (or time) has been specified for this phase</span>
            <span class="c1"># distance (or time) is measured from the start of this phase to the end of this phase</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;target_distance&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s2">&quot;user_options&quot;</span><span class="p">]:</span>
                    <span class="n">target_distance</span> <span class="o">=</span> <span class="n">wrapped_convert_units</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s2">&quot;user_options&quot;</span><span class="p">][</span><span class="s2">&quot;target_distance&quot;</span><span class="p">],</span> <span class="s1">&#39;nmi&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">_distance_constraint&quot;</span><span class="p">,</span>
                        <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
                            <span class="s2">&quot;distance_resid = target_distance - (final_distance - initial_distance)&quot;</span><span class="p">,</span>
                            <span class="n">distance_resid</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;nmi&#39;</span><span class="p">},</span>
                            <span class="n">target_distance</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">target_distance</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;nmi&#39;</span><span class="p">},</span>
                            <span class="n">final_distance</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;nmi&#39;</span><span class="p">},</span>
                            <span class="n">initial_distance</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;nmi&#39;</span><span class="p">},</span>
                        <span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">.timeseries.distance&quot;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">_distance_constraint.final_distance&quot;</span><span class="p">,</span> <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">.timeseries.distance&quot;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">_distance_constraint.initial_distance&quot;</span><span class="p">,</span> <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">_distance_constraint.distance_resid&quot;</span><span class="p">,</span> <span class="n">equals</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mf">1e2</span><span class="p">)</span>

                <span class="c1"># this is only used for analytic phases with a target duration</span>
                <span class="k">if</span> <span class="s1">&#39;target_duration&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s2">&quot;user_options&quot;</span><span class="p">]</span> <span class="ow">and</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s2">&quot;user_options&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;analytic&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="n">target_duration</span> <span class="o">=</span> <span class="n">wrapped_convert_units</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s2">&quot;user_options&quot;</span><span class="p">][</span><span class="s2">&quot;target_duration&quot;</span><span class="p">],</span> <span class="s1">&#39;min&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">_duration_constraint&quot;</span><span class="p">,</span>
                        <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
                            <span class="s2">&quot;duration_resid = target_duration - (final_time - initial_time)&quot;</span><span class="p">,</span>
                            <span class="n">duration_resid</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;min&#39;</span><span class="p">},</span>
                            <span class="n">target_duration</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="n">target_duration</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;min&#39;</span><span class="p">},</span>
                            <span class="n">final_time</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;min&#39;</span><span class="p">},</span>
                            <span class="n">initial_time</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;min&#39;</span><span class="p">},</span>
                        <span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">.timeseries.time&quot;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">_duration_constraint.final_time&quot;</span><span class="p">,</span> <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">.timeseries.time&quot;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">_duration_constraint.initial_time&quot;</span><span class="p">,</span> <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">_duration_constraint.duration_resid&quot;</span><span class="p">,</span> <span class="n">equals</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mf">1e2</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_two_dof_objectives</span><span class="p">()</span>

        <span class="n">ecomp</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
            <span class="s1">&#39;mass_resid = operating_empty_mass + overall_fuel + payload_mass -&#39;</span>
            <span class="s1">&#39; initial_mass&#39;</span><span class="p">,</span>
            <span class="n">operating_empty_mass</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
            <span class="n">overall_fuel</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
            <span class="n">payload_mass</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
            <span class="n">initial_mass</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">},</span>
            <span class="n">mass_resid</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;lbm&#39;</span><span class="p">})</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_method</span> <span class="ow">is</span> <span class="n">GASP</span><span class="p">:</span>
            <span class="n">payload_mass_src</span> <span class="o">=</span> <span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">PASSENGER_PAYLOAD_MASS</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">payload_mass_src</span> <span class="o">=</span> <span class="n">Aircraft</span><span class="o">.</span><span class="n">CrewPayload</span><span class="o">.</span><span class="n">TOTAL_PAYLOAD_MASS</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="s1">&#39;mass_constraint&#39;</span><span class="p">,</span> <span class="n">ecomp</span><span class="p">,</span>
            <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;operating_empty_mass&#39;</span><span class="p">,</span> <span class="n">Aircraft</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">OPERATING_MASS</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;overall_fuel&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">TOTAL_FUEL_MASS</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;payload_mass&#39;</span><span class="p">,</span> <span class="n">payload_mass_src</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;initial_mass&#39;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">)],</span>
            <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;mass_resid&quot;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Constraints</span><span class="o">.</span><span class="n">MASS_RESIDUAL</span><span class="p">)])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">in</span> <span class="p">(</span><span class="n">HEIGHT_ENERGY</span><span class="p">,</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span>
                <span class="n">Mission</span><span class="o">.</span><span class="n">Constraints</span><span class="o">.</span><span class="n">MASS_RESIDUAL</span><span class="p">,</span> <span class="n">equals</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mf">1.e5</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_link_phases_helper_with_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phases</span><span class="p">,</span> <span class="n">option_name</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Initialize a list to keep track of indices where option_name is True</span>
        <span class="n">true_option_indices</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Loop through phases to find where option_name is True</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phases</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">option_name</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">true_option_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

        <span class="c1"># Determine the groups of phases to link based on consecutive indices</span>
        <span class="n">groups_to_link</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_group</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">true_option_indices</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">current_group</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">current_group</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># If the current index is consecutive, add it to the current group</span>
                <span class="n">current_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Otherwise, start a new group and save the previous one</span>
                <span class="n">groups_to_link</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_group</span><span class="p">)</span>
                <span class="n">current_group</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="c1"># Add the last group if it exists</span>
        <span class="k">if</span> <span class="n">current_group</span><span class="p">:</span>
            <span class="n">groups_to_link</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_group</span><span class="p">)</span>

        <span class="c1"># Loop through each group and determine the phases to link</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups_to_link</span><span class="p">:</span>
            <span class="c1"># Extend the group to include the phase before the first True option and after the last True option, if applicable</span>
            <span class="k">if</span> <span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">group</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">group</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Extract the phase names for the current group</span>
            <span class="n">phases_to_link</span> <span class="o">=</span> <span class="p">[</span><span class="n">phases</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">group</span><span class="p">]</span>

            <span class="c1"># Link the phases for the current group</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">phases_to_link</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">link_phases</span><span class="p">(</span><span class="n">phases</span><span class="o">=</span><span class="n">phases_to_link</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="AviaryProblem.link_phases">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.link_phases">[docs]</a>
    <span class="k">def</span> <span class="nf">link_phases</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Link phases together after they&#39;ve been added.</span>

<span class="sd">        Based on which phases the user has selected, we might need</span>
<span class="sd">        special logic to do the Dymos linkages correctly. Some of those</span>
<span class="sd">        connections for the simple GASP and FLOPS mission are shown here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_bus_variables_and_connect</span><span class="p">()</span>

        <span class="n">phases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># In summary, the following code loops over all phases in self.phase_info, gets</span>
        <span class="c1"># the linked variables from each external subsystem in each phase, and stores</span>
        <span class="c1"># the lists of linked variables in lists_to_link. It then gets a list of</span>
        <span class="c1"># unique variable names from lists_to_link and loops over them, creating</span>
        <span class="c1"># a list of phase names for each variable and linking the phases</span>
        <span class="c1"># using self.traj.link_phases().</span>

        <span class="n">lists_to_link</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">):</span>
            <span class="n">lists_to_link</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">external_subsystem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;external_subsystems&#39;</span><span class="p">]:</span>
                <span class="n">lists_to_link</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">external_subsystem</span><span class="o">.</span><span class="n">get_linked_variables</span><span class="p">())</span>

        <span class="c1"># get unique variable names from lists_to_link</span>
        <span class="n">unique_vars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">var</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">lists_to_link</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]))</span>

        <span class="c1"># Phase linking.</span>
        <span class="c1"># If we are under mpi, and traj.phases is running in parallel, then let the</span>
        <span class="c1"># optimizer handle the linkage constraints.  Note that we can technically</span>
        <span class="c1"># paralellize connected phases, but it requires a solver that we would like</span>
        <span class="c1"># to avoid.</span>
        <span class="n">true_unless_mpi</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;parallel_phases&#39;</span><span class="p">]:</span>
            <span class="n">true_unless_mpi</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># loop over unique variable names</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">unique_vars</span><span class="p">:</span>
            <span class="n">phases_to_link</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">lists_to_link</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
                    <span class="n">phases_to_link</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">phases_to_link</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># TODO: hack</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">link_phases</span><span class="p">(</span><span class="n">phases</span><span class="o">=</span><span class="n">phases_to_link</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">connected</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">in</span> <span class="p">(</span><span class="n">HEIGHT_ENERGY</span><span class="p">,</span> <span class="n">SOLVED_2DOF</span><span class="p">):</span>
            <span class="c1"># connect regular_phases with each other if you are optimizing alt or mach</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_link_phases_helper_with_options</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">regular_phases</span><span class="p">,</span> <span class="s1">&#39;optimize_altitude&#39;</span><span class="p">,</span> <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">ALTITUDE</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mf">1.e4</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_link_phases_helper_with_options</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">regular_phases</span><span class="p">,</span> <span class="s1">&#39;optimize_mach&#39;</span><span class="p">,</span> <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">MACH</span><span class="p">)</span>

            <span class="c1"># connect reserve phases with each other if you are optimizing alt or mach</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_link_phases_helper_with_options</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reserve_phases</span><span class="p">,</span> <span class="s1">&#39;optimize_altitude&#39;</span><span class="p">,</span> <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">ALTITUDE</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mf">1.e4</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_link_phases_helper_with_options</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reserve_phases</span><span class="p">,</span> <span class="s1">&#39;optimize_mach&#39;</span><span class="p">,</span> <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">MACH</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">HEIGHT_ENERGY</span><span class="p">:</span>
                <span class="c1"># connect mass and distance between all phases regardless of reserve / non-reserve status</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">link_phases</span><span class="p">(</span><span class="n">phases</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">ref</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span>
                                      <span class="n">connected</span><span class="o">=</span><span class="n">true_unless_mpi</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">link_phases</span><span class="p">(</span><span class="n">phases</span><span class="p">,</span> <span class="p">[</span><span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">MASS</span><span class="p">],</span> <span class="n">ref</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span>
                                      <span class="n">connected</span><span class="o">=</span><span class="n">true_unless_mpi</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">link_phases</span><span class="p">(</span><span class="n">phases</span><span class="p">,</span> <span class="p">[</span><span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">DISTANCE</span><span class="p">],</span> <span class="n">ref</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span>
                                      <span class="n">connected</span><span class="o">=</span><span class="n">true_unless_mpi</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">SOLVED_2DOF</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">link_phases</span><span class="p">(</span><span class="n">phases</span><span class="p">,</span> <span class="p">[</span><span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">MASS</span><span class="p">],</span> <span class="n">connected</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">link_phases</span><span class="p">(</span>
                    <span class="n">phases</span><span class="p">,</span> <span class="p">[</span><span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">DISTANCE</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;ft&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mf">1.e3</span><span class="p">,</span> <span class="n">connected</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">link_phases</span><span class="p">(</span><span class="n">phases</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">connected</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">link_phases</span><span class="p">(</span>
                        <span class="n">phases</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">,</span> <span class="n">connected</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">COLLOCATION</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">phase1</span><span class="p">,</span> <span class="n">phase2</span> <span class="o">=</span> <span class="n">phases</span><span class="p">[</span><span class="n">ii</span><span class="p">:</span><span class="n">ii</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">analytic1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase1</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="s1">&#39;analytic&#39;</span><span class="p">]</span>
                    <span class="n">analytic2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase2</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="s1">&#39;analytic&#39;</span><span class="p">]</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">analytic1</span> <span class="ow">or</span> <span class="n">analytic2</span><span class="p">):</span>
                        <span class="c1"># we always want time, distance, and mass to be continuous</span>
                        <span class="n">states_to_link</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">true_unless_mpi</span><span class="p">,</span>
                            <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">DISTANCE</span><span class="p">:</span> <span class="n">true_unless_mpi</span><span class="p">,</span>
                            <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">MASS</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="p">}</span>

                        <span class="c1"># if both phases are reserve phases or neither is a reserve phase</span>
                        <span class="c1"># (we are not on the boundary between the regular and reserve missions)</span>
                        <span class="c1"># and neither phase is ground roll or rotation (altitude isn&#39;t a state):</span>
                        <span class="c1"># we want altitude to be continous as well</span>
                        <span class="k">if</span> <span class="p">((</span><span class="n">phase1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserve_phases</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">phase2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reserve_phases</span><span class="p">))</span> <span class="ow">and</span> \
                                <span class="ow">not</span> <span class="p">({</span><span class="s2">&quot;groundroll&quot;</span><span class="p">,</span> <span class="s2">&quot;rotation&quot;</span><span class="p">}</span> <span class="o">&amp;</span> <span class="p">{</span><span class="n">phase1</span><span class="p">,</span> <span class="n">phase2</span><span class="p">})</span> <span class="ow">and</span> \
                                <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;accel&#39;</span><span class="p">,</span> <span class="s1">&#39;climb1&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">phase1</span><span class="p">,</span> <span class="n">phase2</span><span class="p">):</span>  <span class="c1"># required for convergence of FwGm</span>
                            <span class="n">states_to_link</span><span class="p">[</span><span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">ALTITUDE</span><span class="p">]</span> <span class="o">=</span> <span class="n">true_unless_mpi</span>

                        <span class="c1"># if either phase is rotation, we need to connect velocity</span>
                        <span class="c1"># ascent to accel also requires velocity</span>
                        <span class="k">if</span> <span class="s1">&#39;rotation&#39;</span> <span class="ow">in</span> <span class="p">(</span><span class="n">phase1</span><span class="p">,</span> <span class="n">phase2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;ascent&#39;</span><span class="p">,</span> <span class="s1">&#39;accel&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">phase1</span><span class="p">,</span> <span class="n">phase2</span><span class="p">):</span>
                            <span class="n">states_to_link</span><span class="p">[</span><span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">VELOCITY</span><span class="p">]</span> <span class="o">=</span> <span class="n">true_unless_mpi</span>
                            <span class="c1"># if the first phase is rotation, we also need alpha</span>
                            <span class="k">if</span> <span class="n">phase1</span> <span class="o">==</span> <span class="s1">&#39;rotation&#39;</span><span class="p">:</span>
                                <span class="n">states_to_link</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="k">for</span> <span class="n">state</span><span class="p">,</span> <span class="n">connected</span> <span class="ow">in</span> <span class="n">states_to_link</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="c1"># in initial guesses, all of the states, other than time use the same name</span>
                            <span class="n">initial_guesses1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase1</span><span class="p">][</span><span class="s1">&#39;initial_guesses&#39;</span><span class="p">]</span>
                            <span class="n">initial_guesses2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase2</span><span class="p">][</span><span class="s1">&#39;initial_guesses&#39;</span><span class="p">]</span>

                            <span class="c1"># if a state is in the initial guesses, get the units of the initial guess</span>
                            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">connected</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">initial_guesses1</span><span class="p">:</span>
                                    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">initial_guesses1</span><span class="p">[</span><span class="n">state</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]}</span>
                                <span class="k">elif</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">initial_guesses2</span><span class="p">:</span>
                                    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">initial_guesses2</span><span class="p">[</span><span class="n">state</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]}</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">link_phases</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">phase1</span><span class="p">,</span> <span class="n">phase2</span><span class="p">],</span> <span class="p">[</span><span class="n">state</span><span class="p">],</span> <span class="n">connected</span><span class="o">=</span><span class="n">connected</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                    <span class="c1"># if either phase is analytic we have to use a linkage_constraint</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># analytic phases use the prefix &quot;initial&quot; for time and distance, but not mass</span>
                        <span class="k">if</span> <span class="n">analytic2</span><span class="p">:</span>
                            <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;initial_&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">add_linkage_constraint</span><span class="p">(</span>
                            <span class="n">phase1</span><span class="p">,</span> <span class="n">phase2</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">connected</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">add_linkage_constraint</span><span class="p">(</span>
                            <span class="n">phase1</span><span class="p">,</span> <span class="n">phase2</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="n">connected</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">add_linkage_constraint</span><span class="p">(</span>
                            <span class="n">phase1</span><span class="p">,</span> <span class="n">phase2</span><span class="p">,</span> <span class="s1">&#39;mass&#39;</span><span class="p">,</span> <span class="s1">&#39;mass&#39;</span><span class="p">,</span> <span class="n">connected</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mf">1.0e5</span><span class="p">)</span>

                <span class="c1"># add all params and promote them to self.model level</span>
                <span class="n">ParamPort</span><span class="o">.</span><span class="n">promote_params</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                    <span class="n">trajs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;traj&quot;</span><span class="p">],</span>
                    <span class="n">phases</span><span class="o">=</span><span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">regular_phases</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reserve_phases</span>
                    <span class="p">],</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">promotes</span><span class="p">(</span>
                    <span class="s2">&quot;traj&quot;</span><span class="p">,</span>
                    <span class="n">inputs</span><span class="o">=</span><span class="p">[</span>
                        <span class="p">(</span><span class="s2">&quot;ascent.parameters:t_init_gear&quot;</span><span class="p">,</span> <span class="s2">&quot;t_init_gear&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;ascent.parameters:t_init_flaps&quot;</span><span class="p">,</span> <span class="s2">&quot;t_init_flaps&quot;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;ascent.t_initial&quot;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Takeoff</span><span class="o">.</span><span class="n">ASCENT_T_INTIIAL</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;ascent.t_duration&quot;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Takeoff</span><span class="o">.</span><span class="n">ASCENT_DURATION</span><span class="p">),</span>
                    <span class="p">],</span>
                <span class="p">)</span>

                <span class="c1"># imitate input_initial for taxi -&gt; groundroll</span>
                <span class="n">eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
                    <span class="s2">&quot;link_taxi_groundroll&quot;</span><span class="p">,</span> <span class="n">om</span><span class="o">.</span><span class="n">EQConstraintComp</span><span class="p">())</span>
                <span class="n">eq</span><span class="o">.</span><span class="n">add_eq_output</span><span class="p">(</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="n">eq_units</span><span class="o">=</span><span class="s2">&quot;lbm&quot;</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                 <span class="n">ref</span><span class="o">=</span><span class="mf">10000.</span><span class="p">,</span> <span class="n">add_constraint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;taxi.mass&quot;</span><span class="p">,</span> <span class="s2">&quot;link_taxi_groundroll.rhs:mass&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="s2">&quot;traj.groundroll.states:mass&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;link_taxi_groundroll.lhs:mass&quot;</span><span class="p">,</span>
                    <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">flat_src_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;traj.ascent.timeseries.time&quot;</span><span class="p">,</span> <span class="s2">&quot;h_fit.time_cp&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="s2">&quot;traj.ascent.timeseries.altitude&quot;</span><span class="p">,</span> <span class="s2">&quot;h_fit.h_cp&quot;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">regular_phases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">.states:mass&#39;</span><span class="p">,</span>
                                   <span class="n">Mission</span><span class="o">.</span><span class="n">Landing</span><span class="o">.</span><span class="n">TOUCHDOWN_MASS</span><span class="p">,</span> <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

                <span class="n">connect_map</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sa">f</span><span class="s2">&quot;traj.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">regular_phases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">.timeseries.distance&quot;</span><span class="p">:</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">RANGE</span><span class="p">,</span>
                <span class="p">}</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">connect_map</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;taxi.mass&quot;</span><span class="p">:</span> <span class="s2">&quot;traj.mass_initial&quot;</span><span class="p">,</span>
                    <span class="n">Mission</span><span class="o">.</span><span class="n">Takeoff</span><span class="o">.</span><span class="n">ROTATION_VELOCITY</span><span class="p">:</span> <span class="s2">&quot;traj.SGMGroundroll_velocity_trigger&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;traj.distance_final&quot;</span><span class="p">:</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">RANGE</span><span class="p">,</span>
                    <span class="s2">&quot;traj.mass_final&quot;</span><span class="p">:</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Landing</span><span class="o">.</span><span class="n">TOUCHDOWN_MASS</span><span class="p">,</span>
                <span class="p">}</span>

            <span class="c1"># promote all ParamPort inputs for analytic segments as well</span>
            <span class="n">param_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ParamPort</span><span class="o">.</span><span class="n">param_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">promotes</span><span class="p">(</span><span class="s2">&quot;taxi&quot;</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">param_list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">promotes</span><span class="p">(</span><span class="s2">&quot;landing&quot;</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">param_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">SHOOTING</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">promotes</span><span class="p">(</span><span class="s2">&quot;traj&quot;</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">param_list</span><span class="p">)</span>
                <span class="c1"># self.model.list_inputs()</span>
                <span class="c1"># self.model.promotes(&quot;traj&quot;, inputs=[&#39;ascent.ODE_group.eoms.&#39;+Aircraft.Design.MAX_FUSELAGE_PITCH_ANGLE])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;taxi.mass&quot;</span><span class="p">,</span> <span class="s2">&quot;vrot.mass&quot;</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">connect_with_common_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="n">source</span><span class="p">,</span>
                    <span class="n">target</span><span class="p">,</span>
                    <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">flat_src_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">connect_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">connect_with_common_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span></div>


<div class="viewcode-block" id="AviaryProblem.add_driver">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.add_driver">[docs]</a>
    <span class="k">def</span> <span class="nf">add_driver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_coloring</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">Verbosity</span><span class="o">.</span><span class="n">BRIEF</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add an optimization driver to the Aviary problem.</span>

<span class="sd">        Depending on the provided optimizer, the method instantiates the relevant driver (ScipyOptimizeDriver or</span>
<span class="sd">        pyOptSparseDriver) and sets the optimizer options. Options for &#39;SNOPT&#39;, &#39;IPOPT&#39;, and &#39;SLSQP&#39; are</span>
<span class="sd">        specified. The method also allows for the declaration of coloring and setting debug print options.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        optimizer : str</span>
<span class="sd">            The name of the optimizer to use. It can be &quot;SLSQP&quot;, &quot;SNOPT&quot;, &quot;IPOPT&quot; or others supported by OpenMDAO.</span>
<span class="sd">            If &quot;SLSQP&quot;, it will instantiate a ScipyOptimizeDriver, else it will instantiate a pyOptSparseDriver.</span>

<span class="sd">        use_coloring : bool, optional</span>
<span class="sd">            If True (default), the driver will declare coloring, which can speed up derivative computations.</span>

<span class="sd">        max_iter : int, optional</span>
<span class="sd">            The maximum number of iterations allowed for the optimization process. Default is 50. This option is</span>
<span class="sd">            applicable to &quot;SNOPT&quot;, &quot;IPOPT&quot;, and &quot;SLSQP&quot; optimizers.</span>

<span class="sd">        verbosity : Verbosity or list, optional</span>
<span class="sd">            If Verbosity.DEBUG, debug print options [&#39;desvars&#39;,&#39;ln_cons&#39;,&#39;nl_cons&#39;,&#39;objs&#39;] will be set. If a list is</span>
<span class="sd">            provided, it will be used as the debug print options.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set defaults for optimizer and use_coloring based on analysis scheme</span>
        <span class="k">if</span> <span class="n">optimizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="s1">&#39;IPOPT&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">SHOOTING</span> <span class="k">else</span> <span class="s1">&#39;SNOPT&#39;</span>
        <span class="k">if</span> <span class="n">use_coloring</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">use_coloring</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">SHOOTING</span> <span class="k">else</span> <span class="kc">True</span>

        <span class="c1"># check if optimizer is SLSQP</span>
        <span class="k">if</span> <span class="n">optimizer</span> <span class="o">==</span> <span class="s2">&quot;SLSQP&quot;</span><span class="p">:</span>
            <span class="n">driver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">ScipyOptimizeDriver</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">driver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">pyOptSparseDriver</span><span class="p">()</span>

        <span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;optimizer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimizer</span>
        <span class="k">if</span> <span class="n">use_coloring</span><span class="p">:</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">declare_coloring</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;optimizer&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;SNOPT&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbosity</span> <span class="o">==</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">QUIET</span><span class="p">:</span>
                <span class="n">isumm</span><span class="p">,</span> <span class="n">iprint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">verbosity</span> <span class="o">==</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">BRIEF</span><span class="p">:</span>
                <span class="n">isumm</span><span class="p">,</span> <span class="n">iprint</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">isumm</span><span class="p">,</span> <span class="n">iprint</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s2">&quot;Major iterations limit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_iter</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s2">&quot;Major optimality tolerance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-4</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s2">&quot;Major feasibility tolerance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-7</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s2">&quot;iSumm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isumm</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s2">&quot;iPrint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iprint</span>
        <span class="k">elif</span> <span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;optimizer&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;IPOPT&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbosity</span> <span class="o">==</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">QUIET</span><span class="p">:</span>
                <span class="n">print_level</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># minimum to get exit status</span>
                <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;print_user_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
            <span class="k">elif</span> <span class="n">verbosity</span> <span class="o">==</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">BRIEF</span><span class="p">:</span>
                <span class="n">print_level</span> <span class="o">=</span> <span class="mi">5</span>
                <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;print_user_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
                <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;print_frequency_iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="k">elif</span> <span class="n">verbosity</span> <span class="o">==</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">:</span>
                <span class="n">print_level</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">print_level</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0E-6</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;mu_init&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-5</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;max_iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_iter</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;print_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">print_level</span>
            <span class="c1"># for faster convergence</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;nlp_scaling_method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;gradient-based&#39;</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;alpha_for_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;safer-min-dual-infeas&#39;</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">opt_settings</span><span class="p">[</span><span class="s1">&#39;mu_strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;monotone&#39;</span>
        <span class="k">elif</span> <span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;optimizer&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;SLSQP&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbosity</span> <span class="o">==</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">QUIET</span><span class="p">:</span>
                <span class="n">disp</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">disp</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;tol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-9</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;maxiter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_iter</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;disp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">disp</span>

        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">!=</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">QUIET</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">verbosity</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;debug_print&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">verbosity</span>
            <span class="k">elif</span> <span class="n">verbosity</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">DEBUG</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;debug_print&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;desvars&#39;</span><span class="p">,</span> <span class="s1">&#39;ln_cons&#39;</span><span class="p">,</span> <span class="s1">&#39;nl_cons&#39;</span><span class="p">,</span> <span class="s1">&#39;objs&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Verbosity</span><span class="o">.</span><span class="n">DEBUG</span> <span class="ow">and</span> <span class="n">optimizer</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;SNOPT&quot;</span><span class="p">,</span> <span class="s2">&quot;IPOPT&quot;</span><span class="p">):</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;print_results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="AviaryProblem.add_design_variables">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.add_design_variables">[docs]</a>
    <span class="k">def</span> <span class="nf">add_design_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds design variables to the Aviary problem.</span>

<span class="sd">        Depending on the mission model and problem type, different design variables and constraints are added.</span>

<span class="sd">        If using the FLOPS model, a design variable is added for the gross mass of the aircraft, with a lower bound of 100,000 lbm and an upper bound of 200,000 lbm.</span>

<span class="sd">        If using the GASP model, the following design variables are added depending on the mission type:</span>
<span class="sd">            - the initial thrust-to-weight ratio of the aircraft during ascent</span>
<span class="sd">            - the duration of the ascent phase</span>
<span class="sd">            - the time constant for the landing gear actuation</span>
<span class="sd">            - the time constant for the flaps actuation</span>

<span class="sd">        In addition, two constraints are added for the GASP model:</span>
<span class="sd">            - the initial altitude of the aircraft with gear extended is constrained to be 50 ft</span>
<span class="sd">            - the initial altitude of the aircraft with flaps extended is constrained to be 400 ft</span>

<span class="sd">        If solving a sizing problem, a design variable is added for the gross mass of the aircraft, and another for the gross mass of the aircraft computed during the mission. A constraint is also added to ensure that the residual range is zero.</span>

<span class="sd">        If solving an alternate problem, only a design variable for the gross mass of the aircraft computed during the mission is added. A constraint is also added to ensure that the residual range is zero.</span>

<span class="sd">        In all cases, a design variable is added for the final cruise mass of the aircraft, with no upper bound, and a residual mass constraint is added to ensure that the mass balances.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># add the engine builder `get_design_vars` dict to a collected dict from the external subsystems</span>

        <span class="c1"># TODO : maybe in the most general case we need to handle DVs in the mission and post-mission as well.</span>
        <span class="c1"># for right now we just handle pre_mission</span>
        <span class="n">all_subsystems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_subsystems</span><span class="p">()</span>

        <span class="c1"># loop through all_subsystems and call `get_design_vars` on each subsystem</span>
        <span class="k">for</span> <span class="n">subsystem</span> <span class="ow">in</span> <span class="n">all_subsystems</span><span class="p">:</span>
            <span class="n">dv_dict</span> <span class="o">=</span> <span class="n">subsystem</span><span class="o">.</span><span class="n">get_design_vars</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">dv_name</span><span class="p">,</span> <span class="n">dv_dict</span> <span class="ow">in</span> <span class="n">dv_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span><span class="n">dv_name</span><span class="p">,</span> <span class="o">**</span><span class="n">dv_dict</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">in</span> <span class="p">(</span><span class="n">HEIGHT_ENERGY</span><span class="p">,</span> <span class="n">SOLVED_2DOF</span><span class="p">):</span>
            <span class="n">optimize_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_mission_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;optimize_mass&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">optimize_mass</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;lbm&#39;</span><span class="p">,</span>
                                          <span class="n">lower</span><span class="o">=</span><span class="mf">100.e2</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">200.e3</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mf">135.e3</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">COLLOCATION</span><span class="p">:</span>
                <span class="c1"># problem formulation to make the trajectory work</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Takeoff</span><span class="o">.</span><span class="n">ASCENT_T_INTIIAL</span><span class="p">,</span>
                                          <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mf">30.0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Takeoff</span><span class="o">.</span><span class="n">ASCENT_DURATION</span><span class="p">,</span>
                                          <span class="n">lower</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mf">10.</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span><span class="s2">&quot;tau_gear&quot;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                                          <span class="n">upper</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;unitless&quot;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span><span class="s2">&quot;tau_flaps&quot;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                                          <span class="n">upper</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;unitless&quot;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span>
                    <span class="s2">&quot;h_fit.h_init_gear&quot;</span><span class="p">,</span> <span class="n">equals</span><span class="o">=</span><span class="mf">50.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;ft&quot;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mf">50.0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="s2">&quot;h_fit.h_init_flaps&quot;</span><span class="p">,</span>
                                          <span class="n">equals</span><span class="o">=</span><span class="mf">400.0</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;ft&quot;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mf">400.0</span><span class="p">)</span>

            <span class="c1"># vehicle sizing problem</span>
            <span class="c1"># size the vehicle (via design GTOW) to meet a target range using all fuel capacity</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_type</span> <span class="ow">is</span> <span class="n">ProblemType</span><span class="o">.</span><span class="n">SIZING</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span>
                    <span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">,</span>
                    <span class="n">lower</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span>
                    <span class="n">upper</span><span class="o">=</span><span class="mf">400.e3</span><span class="p">,</span>
                    <span class="n">units</span><span class="o">=</span><span class="s2">&quot;lbm&quot;</span><span class="p">,</span>
                    <span class="n">ref</span><span class="o">=</span><span class="mi">175_000</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span>
                    <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">,</span>
                    <span class="n">lower</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span>
                    <span class="n">upper</span><span class="o">=</span><span class="mf">400.e3</span><span class="p">,</span>
                    <span class="n">units</span><span class="o">=</span><span class="s2">&quot;lbm&quot;</span><span class="p">,</span>
                    <span class="n">ref</span><span class="o">=</span><span class="mi">175_000</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span>
                    <span class="n">Mission</span><span class="o">.</span><span class="n">Constraints</span><span class="o">.</span><span class="n">RANGE_RESIDUAL</span><span class="p">,</span> <span class="n">equals</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mi">10</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
                    <span class="s2">&quot;gtow_constraint&quot;</span><span class="p">,</span>
                    <span class="n">om</span><span class="o">.</span><span class="n">EQConstraintComp</span><span class="p">(</span>
                        <span class="s2">&quot;GTOW&quot;</span><span class="p">,</span>
                        <span class="n">eq_units</span><span class="o">=</span><span class="s2">&quot;lbm&quot;</span><span class="p">,</span>
                        <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">add_constraint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span>
                        <span class="p">(</span><span class="s2">&quot;lhs:GTOW&quot;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">),</span>
                        <span class="p">(</span><span class="s2">&quot;rhs:GTOW&quot;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">),</span>
                    <span class="p">],</span>
                <span class="p">)</span>

            <span class="c1"># target range problem</span>
            <span class="c1"># fixed vehicle (design GTOW) but variable actual GTOW for off-design mission range</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_type</span> <span class="ow">is</span> <span class="n">ProblemType</span><span class="o">.</span><span class="n">ALTERNATE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_design_var</span><span class="p">(</span>
                    <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">,</span>
                    <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">upper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">units</span><span class="o">=</span><span class="s2">&quot;lbm&quot;</span><span class="p">,</span>
                    <span class="n">ref</span><span class="o">=</span><span class="mi">175_000</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span>
                    <span class="n">Mission</span><span class="o">.</span><span class="n">Constraints</span><span class="o">.</span><span class="n">RANGE_RESIDUAL</span><span class="p">,</span> <span class="n">equals</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_type</span> <span class="ow">is</span> <span class="n">ProblemType</span><span class="o">.</span><span class="n">FALLOUT</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No design variables for Fallout missions&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AviaryProblem.add_objective">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.add_objective">[docs]</a>
    <span class="k">def</span> <span class="nf">add_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objective_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the objective function based on the given objective_type and ref.</span>

<span class="sd">        NOTE: the ref value should be positive for values you&#39;re trying</span>
<span class="sd">        to minimize and negative for values you&#39;re trying to maximize.</span>
<span class="sd">        Please check and double-check that your ref value makes sense</span>
<span class="sd">        for the objective you&#39;re using.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        objective_type : str</span>
<span class="sd">            The type of objective to add. Options are &#39;mass&#39;, &#39;hybrid_objective&#39;, &#39;fuel_burned&#39;, and &#39;fuel&#39;.</span>
<span class="sd">        ref : float</span>
<span class="sd">            The reference value for the objective. If None, a default value will be used based on the objective type. Please see the</span>
<span class="sd">            `default_ref_values` dict for these default values.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">            ValueError: If an invalid problem type is provided.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Dictionary for default reference values</span>
        <span class="n">default_ref_values</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mass&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">5e4</span><span class="p">,</span>
            <span class="s1">&#39;hybrid_objective&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">5e4</span><span class="p">,</span>
            <span class="s1">&#39;fuel_burned&#39;</span><span class="p">:</span> <span class="mf">1e4</span><span class="p">,</span>
            <span class="s1">&#39;fuel&#39;</span><span class="p">:</span> <span class="mf">1e4</span>
        <span class="p">}</span>

        <span class="c1"># Check if an objective type is specified</span>
        <span class="k">if</span> <span class="n">objective_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span> <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">default_ref_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">objective_type</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">final_phase_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regular_phases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">objective_type</span> <span class="o">==</span> <span class="s1">&#39;mass&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">COLLOCATION</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;traj.</span><span class="si">{</span><span class="n">final_phase_name</span><span class="si">}</span><span class="s2">.timeseries.</span><span class="si">{</span><span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">MASS</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">last_phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">_phases</span><span class="o">.</span><span class="n">items</span><span class="p">()[</span><span class="n">final_phase_name</span><span class="p">]</span>
                    <span class="n">last_phase</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span>
                        <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">MASS</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;final&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">objective_type</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;traj.</span><span class="si">{</span><span class="n">final_phase_name</span><span class="si">}</span><span class="s2">.timeseries.time&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">objective_type</span> <span class="o">==</span> <span class="s2">&quot;hybrid_objective&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_hybrid_objective</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span><span class="s2">&quot;obj_comp.obj&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">objective_type</span> <span class="o">==</span> <span class="s2">&quot;fuel_burned&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">FUEL_BURNED</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">objective_type</span> <span class="o">==</span> <span class="s2">&quot;fuel&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Objectives</span><span class="o">.</span><span class="n">FUEL</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>

        <span class="c1"># set objective ref on height-energy missions</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">HEIGHT_ENERGY</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span> <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">default_ref_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;fuel_burned&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">FUEL_BURNED</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># If no &#39;objective_type&#39; is specified, we handle based on &#39;problem_type&#39;</span>
            <span class="c1"># If &#39;ref&#39; is not specified, assign a default value</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span> <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_type</span> <span class="ow">is</span> <span class="n">ProblemType</span><span class="o">.</span><span class="n">SIZING</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Objectives</span><span class="o">.</span><span class="n">FUEL</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_type</span> <span class="ow">is</span> <span class="n">ProblemType</span><span class="o">.</span><span class="n">ALTERNATE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Objectives</span><span class="o">.</span><span class="n">FUEL</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_type</span> <span class="ow">is</span> <span class="n">ProblemType</span><span class="o">.</span><span class="n">FALLOUT</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_objective</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Objectives</span><span class="o">.</span><span class="n">RANGE</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">problem_type</span><span class="si">}</span><span class="s1"> is not a valid problem type.&#39;</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_add_bus_variables_and_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_subsystems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_subsystems</span><span class="p">()</span>

        <span class="n">base_phases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">external_subsystem</span> <span class="ow">in</span> <span class="n">all_subsystems</span><span class="p">:</span>
            <span class="n">bus_variables</span> <span class="o">=</span> <span class="n">external_subsystem</span><span class="o">.</span><span class="n">get_bus_variables</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">bus_variables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">bus_variable</span> <span class="ow">in</span> <span class="n">bus_variables</span><span class="p">:</span>
                    <span class="n">mission_variable_name</span> <span class="o">=</span> <span class="n">bus_variables</span><span class="p">[</span><span class="n">bus_variable</span><span class="p">][</span><span class="s1">&#39;mission_name&#39;</span><span class="p">]</span>

                    <span class="c1"># check if mission_variable_name is a list</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mission_variable_name</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">mission_variable_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">mission_variable_name</span><span class="p">]</span>

                    <span class="c1"># loop over the mission_variable_name list and add each variable to the trajectory</span>
                    <span class="k">for</span> <span class="n">mission_var_name</span> <span class="ow">in</span> <span class="n">mission_variable_name</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;mission_name&#39;</span> <span class="ow">in</span> <span class="n">bus_variables</span><span class="p">[</span><span class="n">bus_variable</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">mission_var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">:</span>
                                <span class="c1"># base_units = self.model.get_io_metadata(includes=f&#39;pre_mission.{external_subsystem.name}.{bus_variable}&#39;)[f&#39;pre_mission.{external_subsystem.name}.{bus_variable}&#39;][&#39;units&#39;]</span>
                                <span class="n">base_units</span> <span class="o">=</span> <span class="n">bus_variables</span><span class="p">[</span><span class="n">bus_variable</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>

                                <span class="n">shape</span> <span class="o">=</span> <span class="n">bus_variables</span><span class="p">[</span><span class="n">bus_variable</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                    <span class="s1">&#39;shape&#39;</span><span class="p">,</span> <span class="n">_unspecified</span><span class="p">)</span>

                                <span class="n">targets</span> <span class="o">=</span> <span class="n">mission_var_name</span>
                                <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">mission_var_name</span><span class="p">:</span>
                                    <span class="c1"># Support for non-hiearchy variables as parameters.</span>
                                    <span class="n">mission_var_name</span> <span class="o">=</span> <span class="n">mission_var_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                                <span class="k">if</span> <span class="s1">&#39;phases&#39;</span> <span class="ow">in</span> <span class="n">bus_variables</span><span class="p">[</span><span class="n">bus_variable</span><span class="p">]:</span>
                                    <span class="c1"># Support for connecting bus variables into a subset of</span>
                                    <span class="c1"># phases.</span>
                                    <span class="n">phases</span> <span class="o">=</span> <span class="n">bus_variables</span><span class="p">[</span><span class="n">bus_variable</span><span class="p">][</span><span class="s1">&#39;phases&#39;</span><span class="p">]</span>

                                    <span class="k">for</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">:</span>
                                        <span class="n">phase</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">)</span>

                                        <span class="n">phase</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="n">mission_var_name</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">static_target</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                            <span class="n">units</span><span class="o">=</span><span class="n">base_units</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">)</span>

                                        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pre_mission.</span><span class="si">{</span><span class="n">bus_variable</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                                           <span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">.parameters:</span><span class="si">{</span><span class="n">mission_var_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">phases</span> <span class="o">=</span> <span class="n">base_phases</span>

                                    <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="n">mission_var_name</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">static_target</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                            <span class="n">units</span><span class="o">=</span><span class="n">base_units</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="p">{</span>
                                                                <span class="n">phase_name</span><span class="p">:</span> <span class="p">[</span><span class="n">mission_var_name</span><span class="p">]</span> <span class="k">for</span> <span class="n">phase_name</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">})</span>

                                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                                        <span class="sa">f</span><span class="s1">&#39;pre_mission.</span><span class="si">{</span><span class="n">bus_variable</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;traj.parameters:&#39;</span><span class="o">+</span><span class="n">mission_var_name</span><span class="p">)</span>

                        <span class="k">if</span> <span class="s1">&#39;post_mission_name&#39;</span> <span class="ow">in</span> <span class="n">bus_variables</span><span class="p">[</span><span class="n">bus_variable</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pre_mission.</span><span class="si">{</span><span class="n">external_subsystem</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">bus_variable</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                               <span class="sa">f</span><span class="s1">&#39;post_mission.</span><span class="si">{</span><span class="n">external_subsystem</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">bus_variables</span><span class="p">[</span><span class="n">bus_variable</span><span class="p">][</span><span class="s2">&quot;post_mission_name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="AviaryProblem.setup">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.setup">[docs]</a>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lightly wrappd setup() method for the problem.</span>

<span class="sd">        Allows us to do pre- and post-setup changes, like adding</span>
<span class="sd">        calls to `set_input_defaults` and do some simple `set_vals`</span>
<span class="sd">        if needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># suppress warnings:</span>
        <span class="c1"># &quot;input variable &#39;...&#39; promoted using &#39;*&#39; was already promoted using &#39;aircraft:*&#39;</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;aviary_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;aviary_metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;phase_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span>

            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">om</span><span class="o">.</span><span class="n">OpenMDAOWarning</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">om</span><span class="o">.</span><span class="n">PromotionWarning</span><span class="p">)</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="AviaryProblem.set_initial_guesses">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.set_initial_guesses">[docs]</a>
    <span class="k">def</span> <span class="nf">set_initial_guesses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call `set_val` on the trajectory for states and controls to seed</span>
<span class="sd">        the problem with reasonable initial guesses. This is especially</span>
<span class="sd">        important for collocation methods.</span>

<span class="sd">        This method first identifies all phases in the trajectory then</span>
<span class="sd">        loops over each phase. Specific initial guesses</span>
<span class="sd">        are added depending on the phase and mission method. Cruise is treated</span>
<span class="sd">        as a special phase for GASP-based missions because it is an AnalyticPhase</span>
<span class="sd">        in Dymos. For this phase, we handle the initial guesses first separately</span>
<span class="sd">        and continue to the next phase after that. For other phases, we set the initial</span>
<span class="sd">        guesses for states and controls according to the information available</span>
<span class="sd">        in the &#39;initial_guesses&#39; attribute of the phase.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Grab the trajectory object from the model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_scheme</span> <span class="ow">is</span> <span class="n">AnalysisScheme</span><span class="o">.</span><span class="n">SHOOTING</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">problem_type</span> <span class="ow">is</span> <span class="n">ProblemType</span><span class="o">.</span><span class="n">SIZING</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="s2">&quot;traj.SGMClimb_&quot;</span><span class="o">+</span><span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">ALTITUDE</span> <span class="o">+</span>
                         <span class="s2">&quot;_trigger&quot;</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cruise_alt</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s2">&quot;ft&quot;</span><span class="p">)</span>

            <span class="k">return</span>

        <span class="n">traj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">traj</span>

        <span class="c1"># Determine which phases to loop over, fetching them from the trajectory</span>
        <span class="n">phase_items</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">_phases</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

        <span class="c1"># Loop over each phase and set initial guesses for the state and control variables</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phase_items</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">SOLVED_2DOF</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">phase_objects</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">apply_initial_guesses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;traj&#39;</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="s1">&#39;ground_roll&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="s1">&#39;fix_initial&#39;</span><span class="p">]:</span>
                    <span class="k">continue</span>

            <span class="c1"># If not, fetch the initial guesses specific to the phase</span>
            <span class="c1"># check if guesses exist for this phase</span>
            <span class="k">if</span> <span class="s2">&quot;initial_guesses&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">]:</span>
                <span class="n">guesses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;initial_guesses&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">guesses</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span> <span class="ow">and</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s2">&quot;user_options&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;analytic&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">guess_key</span><span class="p">,</span> <span class="n">guess_data</span> <span class="ow">in</span> <span class="n">guesses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">val</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="n">guess_data</span>

                    <span class="k">if</span> <span class="s1">&#39;mass&#39;</span> <span class="o">==</span> <span class="n">guess_key</span><span class="p">:</span>
                        <span class="c1"># Set initial and duration mass for the analytic cruise phase.</span>
                        <span class="c1"># Note we are integrating over mass, not time for this phase.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">.t_initial&#39;</span><span class="p">,</span>
                                     <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">.t_duration&#39;</span><span class="p">,</span>
                                     <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Otherwise, set the value of the parameter in the trajectory phase</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">.parameters:</span><span class="si">{</span><span class="n">guess_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                     <span class="n">val</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>

                <span class="k">continue</span>

            <span class="c1"># If not cruise and GASP, add subsystem guesses</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_subsystem_guesses</span><span class="p">(</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span>

            <span class="c1"># Set initial guesses for states and controls for each phase</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_guesses</span><span class="p">(</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">guesses</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_process_guess_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">phase</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process the guess variable, which can either be a float or an array of floats.</span>

<span class="sd">        This method is responsible for interpolating initial guesses when the user</span>
<span class="sd">        provides a list or array of values rather than a single float. It interpolates</span>
<span class="sd">        the guess values across the phase&#39;s domain for a given variable, be it a control</span>
<span class="sd">        or a state variable. The interpolation is performed between -1 and 1 (representing</span>
<span class="sd">        the normalized phase time domain), using the numpy linspace function.</span>

<span class="sd">        The result of this method is a single value or an array of interpolated values</span>
<span class="sd">        that can be used to seed the optimization problem with initial guesses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        val : float or list/array of floats</span>
<span class="sd">            The initial guess value(s) for a particular variable.</span>
<span class="sd">        key : str</span>
<span class="sd">            The key identifying the variable for which the initial guess is provided.</span>
<span class="sd">        phase : Phase</span>
<span class="sd">            The phase for which the variable is being set.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        val : float or array of floats</span>
<span class="sd">            The processed guess value(s) to be used in the optimization problem.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check if val is not a single float</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="c1"># If val is an array of values</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Get the shape of the val array</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

                <span class="c1"># Generate an array of evenly spaced values between -1 and 1,</span>
                <span class="c1"># reshaping to match the shape of the val array</span>
                <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

                <span class="c1"># Check if the key indicates a control or state variable</span>
                <span class="k">if</span> <span class="s2">&quot;controls:&quot;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">or</span> <span class="s2">&quot;states:&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="c1"># If so, strip the first part of the key to match the variable name in phase</span>
                    <span class="n">stripped_key</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>

                    <span class="c1"># Interpolate the initial guess values across the phase&#39;s domain</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">stripped_key</span><span class="p">,</span> <span class="n">xs</span><span class="o">=</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="o">=</span><span class="n">val</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If not a control or state variable, interpolate the initial guess values directly</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">xs</span><span class="o">=</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="o">=</span><span class="n">val</span><span class="p">)</span>

        <span class="c1"># Return the processed guess value(s)</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">_add_subsystem_guesses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds the initial guesses for each subsystem of a given phase to the problem.</span>

<span class="sd">        This method first fetches all subsystems associated with the given phase.</span>
<span class="sd">        It then loops over each subsystem and fetches its initial guesses. For each</span>
<span class="sd">        guess, it identifies whether the guess corresponds to a state or a control</span>
<span class="sd">        variable and then processes the guess variable. After this, the initial</span>
<span class="sd">        guess is set in the problem using the `set_val` method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        phase_name : str</span>
<span class="sd">            The name of the phase for which the subsystem guesses are being added.</span>
<span class="sd">        phase : Phase</span>
<span class="sd">            The phase object for which the subsystem guesses are being added.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get all subsystems associated with the phase</span>
        <span class="n">all_subsystems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_subsystems</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;external_subsystems&#39;</span><span class="p">])</span>

        <span class="c1"># Loop over each subsystem</span>
        <span class="k">for</span> <span class="n">subsystem</span> <span class="ow">in</span> <span class="n">all_subsystems</span><span class="p">:</span>
            <span class="c1"># Fetch the initial guesses for the subsystem</span>
            <span class="n">initial_guesses</span> <span class="o">=</span> <span class="n">subsystem</span><span class="o">.</span><span class="n">get_initial_guesses</span><span class="p">()</span>

            <span class="c1"># Loop over each guess</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">initial_guesses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Identify the type of the guess (state or control)</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;state&#39;</span> <span class="ow">in</span> <span class="nb">type</span><span class="p">:</span>
                    <span class="n">path_string</span> <span class="o">=</span> <span class="s1">&#39;states&#39;</span>
                <span class="k">elif</span> <span class="s1">&#39;control&#39;</span> <span class="ow">in</span> <span class="nb">type</span><span class="p">:</span>
                    <span class="n">path_string</span> <span class="o">=</span> <span class="s1">&#39;controls&#39;</span>

                <span class="c1"># Process the guess variable (handles array interpolation)</span>
                <span class="n">val</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_guess_var</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span>

                <span class="c1"># Set the initial guess in the problem</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">path_string</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_guesses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">guesses</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds the initial guesses for each variable of a given phase to the problem.</span>

<span class="sd">        This method sets the initial guesses for time, control, state, and problem-specific</span>
<span class="sd">        variables for a given phase. If using the GASP model, it also handles some special</span>
<span class="sd">        cases that are not covered in the `phase_info` object. These include initial guesses</span>
<span class="sd">        for mass, time, and distance, which are determined based on the phase name and other</span>
<span class="sd">        mission-related variables.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        phase_name : str</span>
<span class="sd">            The name of the phase for which the guesses are being added.</span>
<span class="sd">        phase : Phase</span>
<span class="sd">            The phase object for which the guesses are being added.</span>
<span class="sd">        guesses : dict</span>
<span class="sd">            A dictionary containing the initial guesses for the phase.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># If using the GASP model, set initial guesses for the rotation mass and flight duration</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">:</span>
            <span class="n">rotation_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_guesses</span><span class="p">[</span><span class="s1">&#39;rotation_mass&#39;</span><span class="p">]</span>
            <span class="n">flight_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_guesses</span><span class="p">[</span><span class="s1">&#39;flight_duration&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">in</span> <span class="p">(</span><span class="n">HEIGHT_ENERGY</span><span class="p">,</span> <span class="n">SOLVED_2DOF</span><span class="p">):</span>
            <span class="n">control_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mach&quot;</span><span class="p">,</span> <span class="s2">&quot;altitude&quot;</span><span class="p">]</span>
            <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">DISTANCE</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">control_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;velocity_rate&quot;</span><span class="p">,</span> <span class="s2">&quot;throttle&quot;</span><span class="p">]</span>
            <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;altitude&quot;</span><span class="p">,</span> <span class="s2">&quot;mass&quot;</span><span class="p">,</span>
                          <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">DISTANCE</span><span class="p">,</span> <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">VELOCITY</span><span class="p">,</span> <span class="s2">&quot;flight_path_angle&quot;</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span> <span class="ow">and</span> <span class="n">phase_name</span> <span class="o">==</span> <span class="s1">&#39;ascent&#39;</span><span class="p">:</span>
                <span class="c1"># Alpha is a control for ascent.</span>
                <span class="n">control_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">)</span>

        <span class="n">prob_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tau_gear&quot;</span><span class="p">,</span> <span class="s2">&quot;tau_flaps&quot;</span><span class="p">]</span>

        <span class="c1"># for the simple mission method, use the provided initial and final mach and altitude values from phase_info</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">in</span> <span class="p">(</span><span class="n">HEIGHT_ENERGY</span><span class="p">,</span> <span class="n">SOLVED_2DOF</span><span class="p">):</span>
            <span class="n">initial_altitude</span> <span class="o">=</span> <span class="n">wrapped_convert_units</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="s1">&#39;initial_altitude&#39;</span><span class="p">],</span> <span class="s1">&#39;ft&#39;</span><span class="p">)</span>
            <span class="n">final_altitude</span> <span class="o">=</span> <span class="n">wrapped_convert_units</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="s1">&#39;final_altitude&#39;</span><span class="p">],</span> <span class="s1">&#39;ft&#39;</span><span class="p">)</span>
            <span class="n">initial_mach</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="s1">&#39;initial_mach&#39;</span><span class="p">]</span>
            <span class="n">final_mach</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="s1">&#39;final_mach&#39;</span><span class="p">]</span>

            <span class="n">guesses</span><span class="p">[</span><span class="s2">&quot;mach&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="n">initial_mach</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">final_mach</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s2">&quot;unitless&quot;</span><span class="p">)</span>
            <span class="n">guesses</span><span class="p">[</span><span class="s2">&quot;altitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="n">initial_altitude</span><span class="p">,</span> <span class="n">final_altitude</span><span class="p">],</span> <span class="s1">&#39;ft&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">HEIGHT_ENERGY</span><span class="p">:</span>
            <span class="c1"># if time not in initial guesses, set it to the average of the initial_bounds and the duration_bounds</span>
            <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">guesses</span><span class="p">:</span>
                <span class="n">initial_bounds</span> <span class="o">=</span> <span class="n">wrapped_convert_units</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="s1">&#39;initial_bounds&#39;</span><span class="p">],</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span>
                <span class="n">duration_bounds</span> <span class="o">=</span> <span class="n">wrapped_convert_units</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="s1">&#39;duration_bounds&#39;</span><span class="p">],</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span>
                <span class="n">guesses</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">initial_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="n">duration_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span>

            <span class="c1"># if time not in initial guesses, set it to the average of the initial_bounds and the duration_bounds</span>
            <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">guesses</span><span class="p">:</span>
                <span class="n">initial_bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="s1">&#39;initial_bounds&#39;</span><span class="p">]</span>
                <span class="n">duration_bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">][</span><span class="s1">&#39;duration_bounds&#39;</span><span class="p">]</span>
                <span class="c1"># Add a check for the initial and duration bounds, raise an error if they are not consistent</span>
                <span class="k">if</span> <span class="n">initial_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">duration_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Initial and duration bounds for </span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2"> are not consistent.&quot;</span><span class="p">)</span>
                <span class="n">guesses</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">initial_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="n">duration_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">initial_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">guess_key</span><span class="p">,</span> <span class="n">guess_data</span> <span class="ow">in</span> <span class="n">guesses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">val</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="n">guess_data</span>

            <span class="c1"># Set initial guess for time variables</span>
            <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="o">==</span> <span class="n">guess_key</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">SOLVED_2DOF</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">.t_initial&#39;</span><span class="p">,</span>
                             <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">.t_duration&#39;</span><span class="p">,</span>
                             <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Set initial guess for control variables</span>
                <span class="k">if</span> <span class="n">guess_key</span> <span class="ow">in</span> <span class="n">control_keys</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">.controls:</span><span class="si">{</span><span class="n">guess_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_guess_var</span><span class="p">(</span>
                            <span class="n">val</span><span class="p">,</span> <span class="n">guess_key</span><span class="p">,</span> <span class="n">phase</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">.polynomial_controls:</span><span class="si">{</span><span class="n">guess_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_guess_var</span><span class="p">(</span>
                                <span class="n">val</span><span class="p">,</span> <span class="n">guess_key</span><span class="p">,</span> <span class="n">phase</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">.bspline_controls:</span><span class="si">{</span><span class="n">guess_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_guess_var</span><span class="p">(</span>
                                <span class="n">val</span><span class="p">,</span> <span class="n">guess_key</span><span class="p">,</span> <span class="n">phase</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">SOLVED_2DOF</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">guess_key</span> <span class="ow">in</span> <span class="n">control_keys</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="c1"># Set initial guess for state variables</span>
                <span class="k">elif</span> <span class="n">guess_key</span> <span class="ow">in</span> <span class="n">state_keys</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">.states:</span><span class="si">{</span><span class="n">guess_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_guess_var</span><span class="p">(</span>
                        <span class="n">val</span><span class="p">,</span> <span class="n">guess_key</span><span class="p">,</span> <span class="n">phase</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">guess_key</span> <span class="ow">in</span> <span class="n">prob_keys</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="n">guess_key</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">guess_key</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">guess_key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_guess_var</span><span class="p">(</span>
                        <span class="n">val</span><span class="p">,</span> <span class="n">guess_key</span><span class="p">,</span> <span class="n">phase</span><span class="p">),</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># raise error if the guess key is not recognized</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Initial guess key </span><span class="si">{</span><span class="n">guess_key</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2"> is not recognized.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">SOLVED_2DOF</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># We need some special logic for these following variables because GASP computes</span>
        <span class="c1"># initial guesses using some knowledge of the mission duration and other variables</span>
        <span class="c1"># that are only available after calling `create_vehicle`. Thus these initial guess</span>
        <span class="c1"># values are not included in the `phase_info` object.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">:</span>
            <span class="n">base_phase</span> <span class="o">=</span> <span class="n">phase_name</span><span class="o">.</span><span class="n">removeprefix</span><span class="p">(</span><span class="s1">&#39;reserve_&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_phase</span> <span class="o">=</span> <span class="n">phase_name</span>
        <span class="k">if</span> <span class="s1">&#39;mass&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">guesses</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">:</span>
                <span class="c1"># Determine a mass guess depending on the phase name</span>
                <span class="k">if</span> <span class="n">base_phase</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;groundroll&quot;</span><span class="p">,</span> <span class="s2">&quot;rotation&quot;</span><span class="p">,</span> <span class="s2">&quot;ascent&quot;</span><span class="p">,</span> <span class="s2">&quot;accel&quot;</span><span class="p">,</span> <span class="s2">&quot;climb1&quot;</span><span class="p">]:</span>
                    <span class="n">mass_guess</span> <span class="o">=</span> <span class="n">rotation_mass</span>
                <span class="k">elif</span> <span class="n">base_phase</span> <span class="o">==</span> <span class="s2">&quot;climb2&quot;</span><span class="p">:</span>
                    <span class="n">mass_guess</span> <span class="o">=</span> <span class="mf">0.99</span> <span class="o">*</span> <span class="n">rotation_mass</span>
                <span class="k">elif</span> <span class="s2">&quot;desc&quot;</span> <span class="ow">in</span> <span class="n">base_phase</span><span class="p">:</span>
                    <span class="n">mass_guess</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cruise_mass_final</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mass_guess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span>
                    <span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;lbm&#39;</span><span class="p">)</span>
            <span class="c1"># Set the mass guess as the initial value for the mass state variable</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">.states:mass&#39;</span><span class="p">,</span>
                         <span class="n">mass_guess</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;lbm&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">guesses</span><span class="p">:</span>
            <span class="c1"># Determine initial time and duration guesses depending on the phase name</span>
            <span class="k">if</span> <span class="s1">&#39;desc1&#39;</span> <span class="o">==</span> <span class="n">base_phase</span><span class="p">:</span>
                <span class="n">t_initial</span> <span class="o">=</span> <span class="n">flight_duration</span><span class="o">*</span><span class="mf">.9</span>
                <span class="n">t_duration</span> <span class="o">=</span> <span class="n">flight_duration</span><span class="o">*</span><span class="mf">.04</span>
            <span class="k">elif</span> <span class="s1">&#39;desc2&#39;</span> <span class="ow">in</span> <span class="n">base_phase</span><span class="p">:</span>
                <span class="n">t_initial</span> <span class="o">=</span> <span class="n">flight_duration</span><span class="o">*</span><span class="mf">.94</span>
                <span class="n">t_duration</span> <span class="o">=</span> <span class="mi">5000</span>
            <span class="c1"># Set the time guesses as the initial values for the time-related trajectory variables</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">.t_initial&quot;</span><span class="p">,</span>
                         <span class="n">t_initial</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">.t_duration&quot;</span><span class="p">,</span>
                         <span class="n">t_duration</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mission_method</span> <span class="ow">is</span> <span class="n">TWO_DEGREES_OF_FREEDOM</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;distance&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">guesses</span><span class="p">:</span>
                <span class="c1"># Determine initial distance guesses depending on the phase name</span>
                <span class="k">if</span> <span class="s1">&#39;desc1&#39;</span> <span class="o">==</span> <span class="n">base_phase</span><span class="p">:</span>
                    <span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_range</span><span class="o">*</span><span class="mf">.97</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_range</span><span class="o">*</span><span class="mf">.99</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s1">&#39;desc2&#39;</span> <span class="ow">in</span> <span class="n">base_phase</span><span class="p">:</span>
                    <span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_range</span><span class="o">*</span><span class="mf">.99</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_range</span><span class="p">]</span>
                <span class="c1"># Set the distance guesses as the initial values for the distance state variable</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_val</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;traj.</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s2">.states:distance&quot;</span><span class="p">,</span> <span class="n">phase</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                        <span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">DISTANCE</span><span class="p">,</span> <span class="n">ys</span><span class="o">=</span><span class="n">ys</span><span class="p">)</span>
                <span class="p">)</span>

<div class="viewcode-block" id="AviaryProblem.run_aviary_problem">
<a class="viewcode-back" href="../../../_srcdocs/packages/interface/methods_for_level2.html#aviary.interface.methods_for_level2.AviaryProblem.run_aviary_problem">[docs]</a>
    <span class="k">def</span> <span class="nf">run_aviary_problem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">record_filename</span><span class="o">=</span><span class="s2">&quot;aviary_history.db&quot;</span><span class="p">,</span>
                           <span class="n">optimization_history_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">restart_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suppress_solver_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">run_driver</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">simulate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function actually runs the Aviary problem, which could be a simulation, optimization, or a driver execution, depending on the arguments provided.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        record_filename : str, optional</span>
<span class="sd">            The name of the database file where the solutions are to be recorded. The default is &quot;aviary_history.db&quot;.</span>
<span class="sd">        optimization_history_filename : str, None</span>
<span class="sd">            The name of the database file where the driver iterations are to be recorded. The default is None.</span>
<span class="sd">        restart_filename : str, optional</span>
<span class="sd">            The name of the file that contains previously computed solutions which are to be used as starting points for this run. If it is None (default), no restart file will be used.</span>
<span class="sd">        suppress_solver_print : bool, optional</span>
<span class="sd">            If True (default), all solvers&#39; print statements will be suppressed. Useful for deeply nested models with multiple solvers so the print statements don&#39;t overwhelm the output.</span>
<span class="sd">        run_driver : bool, optional</span>
<span class="sd">            If True (default), the driver (aka optimizer) will be executed. If False, the problem will be run through one pass -- equivalent to OpenMDAO&#39;s `run_model` behavior.</span>
<span class="sd">        simulate : bool, optional</span>
<span class="sd">            If True, an explicit Dymos simulation will be performed. The default is False.</span>
<span class="sd">        make_plots : bool, optional</span>
<span class="sd">            If True (default), Dymos html plots will be generated as part of the output.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="s1">&#39;verbosity&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_setup</span><span class="p">()</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input_list.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">list_inputs</span><span class="p">(</span><span class="n">out_stream</span><span class="o">=</span><span class="n">outfile</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">suppress_solver_print</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_solver_print</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">optimization_history_filename</span><span class="p">:</span>
            <span class="n">recorder</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">SqliteRecorder</span><span class="p">(</span><span class="n">optimization_history_filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">add_recorder</span><span class="p">(</span><span class="n">recorder</span><span class="p">)</span>

        <span class="c1"># and run mission, and dynamics</span>
        <span class="k">if</span> <span class="n">run_driver</span><span class="p">:</span>
            <span class="n">failed</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">run_problem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_driver</span><span class="o">=</span><span class="n">run_driver</span><span class="p">,</span> <span class="n">simulate</span><span class="o">=</span><span class="n">simulate</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="n">make_plots</span><span class="p">,</span>
                                    <span class="n">solution_record_file</span><span class="o">=</span><span class="n">record_filename</span><span class="p">,</span> <span class="n">restart</span><span class="o">=</span><span class="n">restart_filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># prevent UserWarning that is displayed when an event is triggered</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">)</span>
            <span class="n">failed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_model</span><span class="p">()</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="s1">&#39;verbosity&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;output_list.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">(</span><span class="n">out_stream</span><span class="o">=</span><span class="n">outfile</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">failed</span></div>


    <span class="k">def</span> <span class="nf">_add_hybrid_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_info</span><span class="p">):</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phase_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">takeoff_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span>
            <span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;lbm&#39;</span><span class="p">)</span>

        <span class="n">obj_comp</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;obj = -final_mass / </span><span class="si">{</span><span class="n">takeoff_mass</span><span class="si">}</span><span class="s2"> + final_time / 5.&quot;</span><span class="p">,</span>
                               <span class="n">final_mass</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;lbm&quot;</span><span class="p">},</span>
                               <span class="n">final_time</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;h&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s2">&quot;obj_comp&quot;</span><span class="p">,</span> <span class="n">obj_comp</span><span class="p">)</span>

        <span class="n">final_phase_name</span> <span class="o">=</span> <span class="n">phases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;traj.</span><span class="si">{</span><span class="n">final_phase_name</span><span class="si">}</span><span class="s2">.timeseries.mass&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;obj_comp.final_mass&quot;</span><span class="p">,</span> <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;traj.</span><span class="si">{</span><span class="n">final_phase_name</span><span class="si">}</span><span class="s2">.timeseries.time&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;obj_comp.final_time&quot;</span><span class="p">,</span> <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_add_vrotate_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s2">&quot;vrot_comp&quot;</span><span class="p">,</span> <span class="n">VRotateComp</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;traj.groundroll.states:mass&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;vrot_comp.mass&#39;</span><span class="p">,</span> <span class="n">src_indices</span><span class="o">=</span><span class="n">om</span><span class="o">.</span><span class="n">slicer</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>

        <span class="n">vrot_eq_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s2">&quot;vrot_eq_comp&quot;</span><span class="p">,</span> <span class="n">om</span><span class="o">.</span><span class="n">EQConstraintComp</span><span class="p">())</span>
        <span class="n">vrot_eq_comp</span><span class="o">.</span><span class="n">add_eq_output</span><span class="p">(</span><span class="s2">&quot;v_rotate_error&quot;</span><span class="p">,</span> <span class="n">eq_units</span><span class="o">=</span><span class="s2">&quot;kn&quot;</span><span class="p">,</span>
                                   <span class="n">lhs_name</span><span class="o">=</span><span class="s2">&quot;v_rot_computed&quot;</span><span class="p">,</span> <span class="n">rhs_name</span><span class="o">=</span><span class="s2">&quot;groundroll_v_final&quot;</span><span class="p">,</span> <span class="n">add_constraint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;vrot_comp.Vrot&#39;</span><span class="p">,</span> <span class="s1">&#39;vrot_eq_comp.v_rot_computed&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;traj.groundroll.timeseries.velocity&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;vrot_eq_comp.groundroll_v_final&#39;</span><span class="p">,</span> <span class="n">src_indices</span><span class="o">=</span><span class="n">om</span><span class="o">.</span><span class="n">slicer</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_save_to_csv_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
            <span class="n">fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">]</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">fieldnames</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value_units</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;engine_models&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">value</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="n">value_units</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">_get_all_subsystems</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external_subsystems</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">all_subsystems</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">external_subsystems</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_subsystems</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_mission_info</span><span class="p">[</span><span class="s1">&#39;external_subsystems&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_subsystems</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">external_subsystems</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_builder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_subsystems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine_builder</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">all_subsystems</span>

    <span class="k">def</span> <span class="nf">_add_height_energy_landing_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">landing_options</span> <span class="o">=</span> <span class="n">Landing</span><span class="p">(</span>
            <span class="n">ref_wing_area</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span>
                <span class="n">Aircraft</span><span class="o">.</span><span class="n">Wing</span><span class="o">.</span><span class="n">AREA</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;ft**2&#39;</span><span class="p">),</span>
            <span class="n">Cl_max_ldg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span>
                <span class="n">Mission</span><span class="o">.</span><span class="n">Landing</span><span class="o">.</span><span class="n">LIFT_COEFFICIENT_MAX</span><span class="p">)</span>  <span class="c1"># no units</span>
        <span class="p">)</span>

        <span class="n">landing</span> <span class="o">=</span> <span class="n">landing_options</span><span class="o">.</span><span class="n">build_phase</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="s1">&#39;landing&#39;</span><span class="p">,</span> <span class="n">landing</span><span class="p">,</span> <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;aircraft:*&#39;</span><span class="p">,</span> <span class="s1">&#39;mission:*&#39;</span><span class="p">],</span>
            <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mission:*&#39;</span><span class="p">])</span>

        <span class="n">last_flight_phase_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">last_flight_phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_polynomial_control&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">control_type_string</span> <span class="o">=</span> <span class="s1">&#39;polynomial_control_values&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">control_type_string</span> <span class="o">=</span> <span class="s1">&#39;control_values&#39;</span>

        <span class="n">last_regular_phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regular_phases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">last_regular_phase</span><span class="si">}</span><span class="s1">.states:mass&#39;</span><span class="p">,</span>
                           <span class="n">Mission</span><span class="o">.</span><span class="n">Landing</span><span class="o">.</span><span class="n">TOUCHDOWN_MASS</span><span class="p">,</span> <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">last_regular_phase</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">control_type_string</span><span class="si">}</span><span class="s1">:altitude&#39;</span><span class="p">,</span>
                           <span class="n">Mission</span><span class="o">.</span><span class="n">Landing</span><span class="o">.</span><span class="n">INITIAL_ALTITUDE</span><span class="p">,</span>
                           <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_add_post_mission_takeoff_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">first_flight_phase_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">connect_takeoff_to_climb</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">first_flight_phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;add_initial_mass_constraint&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">connect_takeoff_to_climb</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Takeoff</span><span class="o">.</span><span class="n">FINAL_MASS</span><span class="p">,</span>
                               <span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">first_flight_phase_name</span><span class="si">}</span><span class="s1">.initial_states:mass&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Takeoff</span><span class="o">.</span><span class="n">GROUND_DISTANCE</span><span class="p">,</span>
                               <span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">first_flight_phase_name</span><span class="si">}</span><span class="s1">.initial_states:distance&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">first_flight_phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_polynomial_control&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="n">control_type_string</span> <span class="o">=</span> <span class="s1">&#39;polynomial_control_values&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">control_type_string</span> <span class="o">=</span> <span class="s1">&#39;control_values&#39;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">first_flight_phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;optimize_mach&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="c1"># Create an ExecComp to compute the difference in mach</span>
                <span class="n">mach_diff_comp</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
                    <span class="s1">&#39;mach_resid_for_connecting_takeoff = final_mach - initial_mach&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;mach_diff_comp&#39;</span><span class="p">,</span> <span class="n">mach_diff_comp</span><span class="p">)</span>

                <span class="c1"># Connect the inputs to the mach difference component</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Takeoff</span><span class="o">.</span><span class="n">FINAL_MACH</span><span class="p">,</span>
                                   <span class="s1">&#39;mach_diff_comp.final_mach&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">first_flight_phase_name</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">control_type_string</span><span class="si">}</span><span class="s1">:mach&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;mach_diff_comp.initial_mach&#39;</span><span class="p">,</span> <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="c1"># Add constraint for mach difference</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span>
                    <span class="s1">&#39;mach_diff_comp.mach_resid_for_connecting_takeoff&#39;</span><span class="p">,</span> <span class="n">equals</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_info</span><span class="p">[</span><span class="n">first_flight_phase_name</span><span class="p">][</span><span class="s1">&#39;user_options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;optimize_altitude&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="c1"># Similar steps for altitude difference</span>
                <span class="n">alt_diff_comp</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
                    <span class="s1">&#39;altitude_resid_for_connecting_takeoff = final_altitude - initial_altitude&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;ft&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s1">&#39;alt_diff_comp&#39;</span><span class="p">,</span> <span class="n">alt_diff_comp</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">Mission</span><span class="o">.</span><span class="n">Takeoff</span><span class="o">.</span><span class="n">FINAL_ALTITUDE</span><span class="p">,</span>
                                   <span class="s1">&#39;alt_diff_comp.final_altitude&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;traj.</span><span class="si">{</span><span class="n">first_flight_phase_name</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">control_type_string</span><span class="si">}</span><span class="s1">:altitude&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;alt_diff_comp.initial_altitude&#39;</span><span class="p">,</span> <span class="n">src_indices</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span>
                    <span class="s1">&#39;alt_diff_comp.altitude_resid_for_connecting_takeoff&#39;</span><span class="p">,</span> <span class="n">equals</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_two_dof_landing_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="s2">&quot;landing&quot;</span><span class="p">,</span>
            <span class="n">LandingSegment</span><span class="p">(</span>
                <span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ode_args</span><span class="p">)),</span>
            <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;aircraft:*&#39;</span><span class="p">,</span> <span class="s1">&#39;mission:*&#39;</span><span class="p">,</span>
                             <span class="p">(</span><span class="n">Dynamic</span><span class="o">.</span><span class="n">Mission</span><span class="o">.</span><span class="n">MASS</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Landing</span><span class="o">.</span><span class="n">TOUCHDOWN_MASS</span><span class="p">)],</span>
            <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mission:*&#39;</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_two_dof_objectives</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="s2">&quot;fuel_obj&quot;</span><span class="p">,</span>
            <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
                <span class="s2">&quot;reg_objective = overall_fuel/10000 + ascent_duration/30.&quot;</span><span class="p">,</span>
                <span class="n">reg_objective</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;unitless&quot;</span><span class="p">},</span>
                <span class="n">ascent_duration</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                <span class="n">overall_fuel</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;lbm&quot;</span><span class="p">},</span>
            <span class="p">),</span>
            <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;ascent_duration&quot;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Takeoff</span><span class="o">.</span><span class="n">ASCENT_DURATION</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;overall_fuel&quot;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">TOTAL_FUEL_MASS</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;reg_objective&quot;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Objectives</span><span class="o">.</span><span class="n">FUEL</span><span class="p">)],</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="s2">&quot;range_obj&quot;</span><span class="p">,</span>
            <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
                <span class="s2">&quot;reg_objective = -actual_range/1000 + ascent_duration/30.&quot;</span><span class="p">,</span>
                <span class="n">reg_objective</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;unitless&quot;</span><span class="p">},</span>
                <span class="n">ascent_duration</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                <span class="n">actual_range</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_range</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;NM&quot;</span><span class="p">},</span>
            <span class="p">),</span>
            <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;actual_range&quot;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">RANGE</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;ascent_duration&quot;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Takeoff</span><span class="o">.</span><span class="n">ASCENT_DURATION</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;reg_objective&quot;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Objectives</span><span class="o">.</span><span class="n">RANGE</span><span class="p">)],</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span>
            <span class="s2">&quot;range_constraint&quot;</span><span class="p">,</span>
            <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span>
                <span class="s2">&quot;range_resid = target_range - actual_range&quot;</span><span class="p">,</span>
                <span class="n">target_range</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_range</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;NM&quot;</span><span class="p">},</span>
                <span class="n">actual_range</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_range</span> <span class="o">-</span> <span class="mi">25</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;NM&quot;</span><span class="p">},</span>
                <span class="n">range_resid</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;NM&quot;</span><span class="p">},</span>
            <span class="p">),</span>
            <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;actual_range&quot;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">RANGE</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;target_range&quot;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">RANGE</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;range_resid&quot;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Constraints</span><span class="o">.</span><span class="n">RANGE_RESIDUAL</span><span class="p">)],</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_fuel_reserve_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post_mission</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">reserves_name</span><span class="o">=</span><span class="n">Mission</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">RESERVE_FUEL</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">post_mission</span><span class="p">:</span>
            <span class="n">reserve_calc_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_mission</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reserve_calc_location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>

        <span class="n">RESERVE_FUEL_FRACTION</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span>
            <span class="n">Aircraft</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">RESERVE_FUEL_FRACTION</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;unitless&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">RESERVE_FUEL_FRACTION</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">reserve_fuel_frac</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span><span class="s1">&#39;reserve_fuel_frac_mass = reserve_fuel_fraction * (takeoff_mass - final_mass)&#39;</span><span class="p">,</span>
                                            <span class="n">reserve_fuel_frac_mass</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;lbm&quot;</span><span class="p">},</span>
                                            <span class="n">reserve_fuel_fraction</span><span class="o">=</span><span class="p">{</span>
                                                <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;unitless&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">RESERVE_FUEL_FRACTION</span><span class="p">},</span>
                                            <span class="n">final_mass</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;lbm&quot;</span><span class="p">},</span>
                                            <span class="n">takeoff_mass</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;lbm&quot;</span><span class="p">})</span>

            <span class="n">reserve_calc_location</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s2">&quot;reserve_fuel_frac&quot;</span><span class="p">,</span> <span class="n">reserve_fuel_frac</span><span class="p">,</span>
                                                <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;takeoff_mass&quot;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">GROSS_MASS</span><span class="p">),</span>
                                                                 <span class="p">(</span><span class="s2">&quot;final_mass&quot;</span><span class="p">,</span>
                                                                  <span class="n">Mission</span><span class="o">.</span><span class="n">Landing</span><span class="o">.</span><span class="n">TOUCHDOWN_MASS</span><span class="p">),</span>
                                                                 <span class="p">(</span><span class="s2">&quot;reserve_fuel_fraction&quot;</span><span class="p">,</span> <span class="n">Aircraft</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">RESERVE_FUEL_FRACTION</span><span class="p">)],</span>
                                                <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;reserve_fuel_frac_mass&quot;</span><span class="p">])</span>

        <span class="n">RESERVE_FUEL_ADDITIONAL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aviary_inputs</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span>
            <span class="n">Aircraft</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">RESERVE_FUEL_ADDITIONAL</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;lbm&#39;</span><span class="p">)</span>
        <span class="n">reserve_fuel</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">ExecComp</span><span class="p">(</span><span class="s1">&#39;reserve_fuel = reserve_fuel_frac_mass + reserve_fuel_additional + reserve_fuel_burned&#39;</span><span class="p">,</span>
                                   <span class="n">reserve_fuel</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;lbm&quot;</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                                   <span class="n">reserve_fuel_frac_mass</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;lbm&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                                   <span class="n">reserve_fuel_additional</span><span class="o">=</span><span class="p">{</span>
                                       <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;lbm&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">RESERVE_FUEL_ADDITIONAL</span><span class="p">},</span>
                                   <span class="n">reserve_fuel_burned</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;lbm&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>

        <span class="n">reserve_calc_location</span><span class="o">.</span><span class="n">add_subsystem</span><span class="p">(</span><span class="s2">&quot;reserve_fuel&quot;</span><span class="p">,</span> <span class="n">reserve_fuel</span><span class="p">,</span>
                                            <span class="n">promotes_inputs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;reserve_fuel_frac_mass&quot;</span><span class="p">,</span>
                                                             <span class="p">(</span><span class="s2">&quot;reserve_fuel_additional&quot;</span><span class="p">,</span>
                                                              <span class="n">Aircraft</span><span class="o">.</span><span class="n">Design</span><span class="o">.</span><span class="n">RESERVE_FUEL_ADDITIONAL</span><span class="p">),</span>
                                                             <span class="p">(</span><span class="s2">&quot;reserve_fuel_burned&quot;</span><span class="p">,</span> <span class="n">Mission</span><span class="o">.</span><span class="n">Summary</span><span class="o">.</span><span class="n">RESERVE_FUEL_BURNED</span><span class="p">)],</span>
                                            <span class="n">promotes_outputs</span><span class="o">=</span><span class="p">[</span>
                                                <span class="p">(</span><span class="s2">&quot;reserve_fuel&quot;</span><span class="p">,</span> <span class="n">reserves_name</span><span class="p">)]</span>
                                            <span class="p">)</span></div>

</pre></div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Aviary team at NASA
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>